---
description: 
globs: 
alwaysApply: false
---
# å—æ„ç§‹æ£ å¼€å‘è§„èŒƒ

## ğŸ¯ ä»£ç ç¼–å†™åŸåˆ™

### æ ¸å¿ƒåŸåˆ™
- **ç”¨æˆ·å¯¼å‘**: å§‹ç»ˆç«™åœ¨ç”¨æˆ·è§’åº¦æ€è€ƒï¼Œä¼˜å…ˆæ»¡è¶³ç”¨æˆ·éœ€æ±‚
- **ç®€å•æœ‰æ•ˆ**: é€‰æ‹©æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆï¼Œé¿å…è¿‡åº¦è®¾è®¡
- **å¯è¯»æ€§ä¼˜å…ˆ**: ä»£ç è¦æ˜“äºç†è§£å’Œç»´æŠ¤
- **ä¸­æ–‡æ³¨é‡Š**: æ‰€æœ‰ä»£ç å¿…é¡»æ·»åŠ ä¸­æ–‡æ³¨é‡Šè¯´æ˜

## ğŸ“ æ³¨é‡Šè§„èŒƒ

### Pythonä»£ç æ³¨é‡Š
```python
def get_products(page=1, size=10, filters=None):
    """
    è·å–äº§å“åˆ—è¡¨
    
    å‚æ•°:
        page (int): é¡µç ï¼Œé»˜è®¤ä¸º1
        size (int): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤ä¸º10
        filters (dict): ç­›é€‰æ¡ä»¶ï¼ŒåŒ…å«å¹´ä»½ã€æè´¨ã€ä¸»é¢˜ç­‰
    
    è¿”å›:
        dict: åŒ…å«äº§å“åˆ—è¡¨å’Œåˆ†é¡µä¿¡æ¯çš„å­—å…¸
    """
    # æ„å»ºæŸ¥è¯¢æ¡ä»¶
    query = Product.query
    
    # åº”ç”¨ç­›é€‰æ¡ä»¶
    if filters:
        if filters.get('year'):
            query = query.filter(Product.year == filters['year'])  # æŒ‰å¹´ä»½ç­›é€‰
        if filters.get('material'):
            query = query.filter(Product.material.contains(filters['material']))  # æŒ‰æè´¨ç­›é€‰
    
    # æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢
    pagination = query.paginate(page=page, per_page=size, error_out=False)
    
    return {
        'products': [product.to_dict() for product in pagination.items],  # è½¬æ¢ä¸ºå­—å…¸æ ¼å¼
        'total': pagination.total,  # æ€»æ•°é‡
        'pages': pagination.pages,  # æ€»é¡µæ•°
        'current_page': page  # å½“å‰é¡µç 
    }
```

### JavaScriptä»£ç æ³¨é‡Š
```javascript
/**
 * è·å–äº§å“åˆ—è¡¨æ•°æ®
 * @param {Object} params - æŸ¥è¯¢å‚æ•°
 * @param {number} params.page - é¡µç 
 * @param {number} params.size - æ¯é¡µæ•°é‡
 * @param {Object} params.filters - ç­›é€‰æ¡ä»¶
 * @returns {Promise} è¿”å›äº§å“åˆ—è¡¨çš„Promiseå¯¹è±¡
 */
async function fetchProducts(params = {}) {
    try {
        // æ„å»ºæŸ¥è¯¢å‚æ•°
        const queryParams = new URLSearchParams({
            page: params.page || 1,
            size: params.size || 12
        });
        
        // æ·»åŠ ç­›é€‰æ¡ä»¶åˆ°æŸ¥è¯¢å‚æ•°
        if (params.filters) {
            Object.keys(params.filters).forEach(key => {
                if (params.filters[key]) {
                    queryParams.append(key, params.filters[key]);
                }
            });
        }
        
        // å‘é€APIè¯·æ±‚
        const response = await fetch(`/api/products?${queryParams}`);
        
        if (!response.ok) {
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        }
        
        // è§£æå“åº”æ•°æ®
        const data = await response.json();
        return data;
        
    } catch (error) {
        console.error('è·å–äº§å“åˆ—è¡¨å¤±è´¥:', error);
        throw error;
    }
}
```

### SQLæŸ¥è¯¢æ³¨é‡Š
```python
# æŸ¥è¯¢æœ€å—æ¬¢è¿çš„äº§å“ï¼ˆæŒ‰æŸ¥çœ‹æ¬¡æ•°æ’åºï¼‰
popular_products_query = """
    SELECT 
        p.id,
        p.name,
        p.image_url,
        p.view_count,
        COUNT(f.id) as favorite_count
    FROM products p
    LEFT JOIN favorites f ON p.id = f.product_id
    WHERE p.status = 'active'  -- åªæŸ¥è¯¢æ´»è·ƒäº§å“
    GROUP BY p.id, p.name, p.image_url, p.view_count
    ORDER BY p.view_count DESC, favorite_count DESC
    LIMIT %s
"""
```

## ğŸ“ æ–‡ä»¶ç»„ç»‡è§„èŒƒ

### åç«¯æ–‡ä»¶ç»“æ„
```
backend/
â”œâ”€â”€ app.py                    # åº”ç”¨ä¸»å…¥å£æ–‡ä»¶
â”œâ”€â”€ config/
â”‚   â””â”€â”€ config.py            # æ•°æ®åº“å’Œåº”ç”¨é…ç½®
â”œâ”€â”€ models/                  # æ•°æ®æ¨¡å‹å±‚
â”‚   â”œâ”€â”€ __init__.py         # æ¨¡å‹åˆå§‹åŒ–
â”‚   â”œâ”€â”€ product.py          # äº§å“æ¨¡å‹
â”‚   â””â”€â”€ admin.py            # ç®¡ç†å‘˜æ¨¡å‹
â”œâ”€â”€ routes/                  # è·¯ç”±å±‚ï¼ˆæ§åˆ¶å™¨ï¼‰
â”‚   â”œâ”€â”€ __init__.py         # è·¯ç”±åˆå§‹åŒ–
â”‚   â””â”€â”€ api.py              # APIè·¯ç”±å®šä¹‰
â”œâ”€â”€ services/                # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ __init__.py         # æœåŠ¡åˆå§‹åŒ–
â”‚   â””â”€â”€ product_service.py  # äº§å“ç›¸å…³ä¸šåŠ¡é€»è¾‘
â””â”€â”€ utils/                   # å·¥å…·å‡½æ•°å±‚
    â”œâ”€â”€ __init__.py         # å·¥å…·åˆå§‹åŒ–
    â””â”€â”€ db_utils.py         # æ•°æ®åº“å·¥å…·å‡½æ•°
```

### å‰ç«¯æ–‡ä»¶ç»“æ„
```
frontend/
â”œâ”€â”€ index.html              # ä¸»é¡µé¢æ¨¡æ¿
â”œâ”€â”€ server.py               # å‰ç«¯æœåŠ¡å™¨
â”œâ”€â”€ static/                 # é™æ€èµ„æº
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ main.css        # ä¸»æ ·å¼æ–‡ä»¶
â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â”œâ”€â”€ main.js         # ä¸»é€»è¾‘æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ api.js          # APIè°ƒç”¨å°è£…
â”‚   â”‚   â”œâ”€â”€ utils.js        # å·¥å…·å‡½æ•°
â”‚   â”‚   â””â”€â”€ components/     # ç»„ä»¶æ–‡ä»¶å¤¹
â”‚   â””â”€â”€ images/             # å›¾ç‰‡èµ„æºï¼ˆæŒ‰äº§å“ç³»åˆ—åˆ†ç±»ï¼‰
â””â”€â”€ admin/                  # ç®¡ç†åå°ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰
```

## ğŸ”§ ä»£ç é£æ ¼è§„èŒƒ

### Pythonä»£ç é£æ ¼
- ä½¿ç”¨4ä¸ªç©ºæ ¼ç¼©è¿›ï¼Œä¸ä½¿ç”¨Tab
- å‡½æ•°åä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿ï¼š`get_product_list()`
- ç±»åä½¿ç”¨é©¼å³°å‘½åï¼š`ProductService`
- å¸¸é‡ä½¿ç”¨å…¨å¤§å†™ï¼š`DEFAULT_PAGE_SIZE = 10`
- å¯¼å…¥é¡ºåºï¼šæ ‡å‡†åº“ â†’ ç¬¬ä¸‰æ–¹åº“ â†’ æœ¬åœ°æ¨¡å—

### JavaScriptä»£ç é£æ ¼
- ä½¿ç”¨2ä¸ªç©ºæ ¼ç¼©è¿›
- å˜é‡åä½¿ç”¨é©¼å³°å‘½åï¼š`productList`
- å¸¸é‡ä½¿ç”¨å…¨å¤§å†™ï¼š`const API_BASE_URL = '/api'`
- ä½¿ç”¨ç°ä»£ES6+è¯­æ³•ï¼šç®­å¤´å‡½æ•°ã€æ¨¡æ¿å­—ç¬¦ä¸²ã€è§£æ„èµ‹å€¼ç­‰

### CSSä»£ç é£æ ¼
- ä½¿ç”¨2ä¸ªç©ºæ ¼ç¼©è¿›
- ç±»åä½¿ç”¨çŸ­æ¨ªçº¿è¿æ¥ï¼š`.product-card`
- æŒ‰åŠŸèƒ½åˆ†ç»„ç»„ç»‡æ ·å¼ï¼šåŸºç¡€æ ·å¼ â†’ ç»„ä»¶æ ·å¼ â†’ é¡µé¢æ ·å¼
- ä½¿ç”¨CSSå˜é‡å®šä¹‰ä¸»é¢˜è‰²å½©å’Œå°ºå¯¸

## ğŸ—ï¸ æ¶æ„è®¾è®¡åŸåˆ™

### åç«¯æ¶æ„
- **åˆ†å±‚æ¶æ„**: Models â†’ Services â†’ Routes â†’ App
- **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½é¢†åŸŸ
- **ä¾èµ–æ³¨å…¥**: Serviceå±‚æ³¨å…¥åˆ°Routeå±‚
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•

### å‰ç«¯æ¶æ„
- **ç»„ä»¶åŒ–è®¾è®¡**: å¯å¤ç”¨çš„UIç»„ä»¶
- **æ•°æ®é©±åŠ¨**: ä½¿ç”¨Vue.jsè¿›è¡Œå“åº”å¼æ•°æ®ç»‘å®š
- **APIå°è£…**: ç»Ÿä¸€çš„APIè°ƒç”¨æ¥å£
- **çŠ¶æ€ç®¡ç†**: ç®€å•çš„çŠ¶æ€ç®¡ç†ï¼Œé¿å…è¿‡åº¦å¤æ‚åŒ–

### æ•°æ®åº“è®¾è®¡
- **è§„èŒƒåŒ–è®¾è®¡**: éµå¾ªç¬¬ä¸‰èŒƒå¼
- **ç´¢å¼•ä¼˜åŒ–**: ä¸ºæŸ¥è¯¢å­—æ®µæ·»åŠ é€‚å½“ç´¢å¼•
- **å­—æ®µå‘½å**: ä½¿ç”¨è‹±æ–‡åç§°ï¼Œè§åçŸ¥æ„
- **æ•°æ®ç±»å‹**: é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹ï¼Œé¿å…æµªè´¹ç©ºé—´

## ğŸš€ æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

### åç«¯æ€§èƒ½
```python
# ä½¿ç”¨æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
def get_products_optimized(filters=None):
    """
    ä¼˜åŒ–çš„äº§å“æŸ¥è¯¢å‡½æ•°
    - ä½¿ç”¨ç´¢å¼•å­—æ®µè¿›è¡Œç­›é€‰
    - é¿å…N+1æŸ¥è¯¢é—®é¢˜
    - åˆç†ä½¿ç”¨åˆ†é¡µ
    """
    query = db.session.query(Product).options(
        # é¢„åŠ è½½å…³è”æ•°æ®ï¼Œé¿å…N+1æŸ¥è¯¢
        joinedload(Product.category),
        joinedload(Product.images)
    )
    
    # ä½¿ç”¨ç´¢å¼•å­—æ®µè¿›è¡Œç­›é€‰
    if filters:
        if filters.get('year'):
            query = query.filter(Product.year == filters['year'])
        if filters.get('status'):
            query = query.filter(Product.status == filters['status'])
    
    return query
```

### å‰ç«¯æ€§èƒ½
```javascript
// å›¾ç‰‡æ‡’åŠ è½½å®ç°
function initLazyLoading() {
    const images = document.querySelectorAll('img[data-src]');
    
    const imageObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                // åŠ è½½çœŸå®å›¾ç‰‡
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
                imageObserver.unobserve(img);
            }
        });
    });
    
    images.forEach(img => imageObserver.observe(img));
}
```

## ğŸ”’ å®‰å…¨è§„èŒƒ

### è¾“å…¥éªŒè¯
```python
from werkzeug.utils import secure_filename
import re

def validate_product_data(data):
    """
    éªŒè¯äº§å“æ•°æ®çš„å®‰å…¨æ€§å’Œæœ‰æ•ˆæ€§
    """
    errors = []
    
    # éªŒè¯äº§å“åç§°
    if not data.get('name') or len(data['name']) < 2:
        errors.append('äº§å“åç§°è‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦')
    
    # éªŒè¯å¹´ä»½
    if data.get('year') and not re.match(r'^\d{4}$', str(data['year'])):
        errors.append('å¹´ä»½æ ¼å¼ä¸æ­£ç¡®')
    
    # éªŒè¯æ–‡ä»¶åå®‰å…¨æ€§
    if data.get('image_filename'):
        secure_name = secure_filename(data['image_filename'])
        if secure_name != data['image_filename']:
            errors.append('æ–‡ä»¶ååŒ…å«ä¸å®‰å…¨å­—ç¬¦')
    
    return errors
```

### SQLæ³¨å…¥é˜²æŠ¤
```python
# æ­£ç¡®çš„å‚æ•°åŒ–æŸ¥è¯¢æ–¹å¼
def search_products_safe(keyword):
    """
    å®‰å…¨çš„äº§å“æœç´¢å‡½æ•°ï¼Œé˜²æ­¢SQLæ³¨å…¥
    """
    # ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²æ‹¼æ¥
    query = text("""
        SELECT * FROM products 
        WHERE name LIKE :keyword 
        OR description LIKE :keyword
    """)
    
    # å‚æ•°ç»‘å®šï¼Œè‡ªåŠ¨è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
    results = db.session.execute(query, {
        'keyword': f'%{keyword}%'
    }).fetchall()
    
    return results
```

## ğŸ“Š æµ‹è¯•è§„èŒƒ

### å•å…ƒæµ‹è¯•ç¤ºä¾‹
```python
import unittest
from backend.services.product_service import ProductService

class TestProductService(unittest.TestCase):
    """äº§å“æœåŠ¡æµ‹è¯•ç±»"""
    
    def setUp(self):
        """æµ‹è¯•å‰å‡†å¤‡å·¥ä½œ"""
        self.service = ProductService()
    
    def test_get_products_with_filters(self):
        """æµ‹è¯•å¸¦ç­›é€‰æ¡ä»¶çš„äº§å“æŸ¥è¯¢"""
        filters = {'year': '2023', 'material': 'çœŸä¸'}
        result = self.service.get_products(filters=filters)
        
        # éªŒè¯è¿”å›ç»“æœç»“æ„
        self.assertIn('products', result)
        self.assertIn('total', result)
        
        # éªŒè¯ç­›é€‰æ¡ä»¶ç”Ÿæ•ˆ
        for product in result['products']:
            self.assertEqual(product['year'], '2023')
            self.assertIn('çœŸä¸', product['material'])
```

## ğŸ› ï¸ è°ƒè¯•å’Œæ—¥å¿—è§„èŒƒ

### æ—¥å¿—è®°å½•
```python
import logging
from datetime import datetime

# é…ç½®æ—¥å¿—æ ¼å¼
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/backend.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

def process_product_order(order_data):
    """
    å¤„ç†äº§å“è®¢å•ï¼ŒåŒ…å«å®Œæ•´çš„æ—¥å¿—è®°å½•
    """
    try:
        logger.info(f"å¼€å§‹å¤„ç†è®¢å•: {order_data.get('order_id')}")
        
        # ä¸šåŠ¡é€»è¾‘å¤„ç†
        result = handle_order_logic(order_data)
        
        logger.info(f"è®¢å•å¤„ç†æˆåŠŸ: {order_data.get('order_id')}")
        return result
        
    except ValueError as e:
        logger.error(f"è®¢å•æ•°æ®éªŒè¯å¤±è´¥: {e}")
        raise
    except Exception as e:
        logger.error(f"è®¢å•å¤„ç†å¼‚å¸¸: {e}", exc_info=True)
        raise
```

---

*æœ¬å¼€å‘è§„èŒƒä¸ [project-management.mdc](mdc:.cursor/rules/project-management.mdc) é…åˆä½¿ç”¨ï¼Œç¡®ä¿é¡¹ç›®ä»£ç è´¨é‡å’Œä¸€è‡´æ€§*
