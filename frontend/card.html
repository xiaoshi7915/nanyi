<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">å—æ„ç§‹æ£  - æ±‰æ–‡åŒ–å¸ƒæ–™</title>
    
    <!-- å¾®ä¿¡åˆ†äº«ä¼˜åŒ– -->
    <meta property="og:title" content="å—æ„ç§‹æ£  - æ±‰æ–‡åŒ–å¸ƒæ–™è®¾è®¡" />
    <meta property="og:description" content="ä¼ æ‰¿ç»å…¸ï¼Œåˆ›æ–°æœªæ¥ - æ±‰æ–‡åŒ–å¸ƒæ–™è®¾è®¡çš„è‰ºæœ¯ä¹‹ç¾" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="" />
    <meta property="og:image" content="http://products.nanyiqiutang.cn/static/images/ç‰¡ä¸¹äº­æ¦‚å¿µå›¾.jpg" />
    <meta property="og:image:width" content="800" />
    <meta property="og:image:height" content="600" />
    <meta property="og:site_name" content="å—æ„ç§‹æ£ " />
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="å—æ„ç§‹æ£  - æ±‰æ–‡åŒ–å¸ƒæ–™è®¾è®¡" />
    <meta name="twitter:description" content="ä¼ æ‰¿ç»å…¸ï¼Œåˆ›æ–°æœªæ¥ - æ±‰æ–‡åŒ–å¸ƒæ–™è®¾è®¡çš„è‰ºæœ¯ä¹‹ç¾" />
    <meta name="twitter:image" content="http://products.nanyiqiutang.cn/static/images/ç‰¡ä¸¹äº­æ¦‚å¿µå›¾.jpg" />
    
    <!-- å¾®ä¿¡åˆ†äº«ä¸“ç”¨ -->
    <meta itemprop="name" content="å—æ„ç§‹æ£  - æ±‰æ–‡åŒ–å¸ƒæ–™è®¾è®¡" />
    <meta itemprop="description" content="ä¼ æ‰¿ç»å…¸ï¼Œåˆ›æ–°æœªæ¥ - æ±‰æ–‡åŒ–å¸ƒæ–™è®¾è®¡çš„è‰ºæœ¯ä¹‹ç¾" />
    <meta itemprop="image" content="http://products.nanyiqiutang.cn/static/images/ç‰¡ä¸¹äº­æ¦‚å¿µå›¾.jpg" />
    
    <!-- å¾®ä¿¡åˆ†äº«é…ç½® -->
    <meta name="wechat:title" content="å—æ„ç§‹æ£  - æ±‰æ–‡åŒ–å¸ƒæ–™è®¾è®¡" />
    <meta name="wechat:desc" content="ä¼ æ‰¿ç»å…¸ï¼Œåˆ›æ–°æœªæ¥ - æ±‰æ–‡åŒ–å¸ƒæ–™è®¾è®¡çš„è‰ºæœ¯ä¹‹ç¾" />
    <meta name="wechat:imgUrl" content="http://products.nanyiqiutang.cn/static/images/ç‰¡ä¸¹äº­æ¦‚å¿µå›¾.jpg" />
    <meta name="wechat:link" content="" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .share-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            max-width: 400px;
            width: 100%;
            position: relative;
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .brand-name {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .brand-subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .card-body {
            padding: 25px;
        }
        
        .inspiration-section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .inspiration-text {
            color: #666;
            line-height: 1.3;
            font-size: 0.7rem;
            background: #f8f9fa;
            padding: 8px 10px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            margin-bottom: 8px;
            max-height: none;
            overflow: visible;
        }
        
        .images-section {
            margin-bottom: 25px;
        }
        
        .images-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #f0f0f0;
            margin-bottom: 8px;
        }
        
        .image-item img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .image-type {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: white;
            font-size: 0.7rem;
            padding: 4px 6px;
            text-align: center;
        }
        
        .brand-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .brand-info-compact {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .info-row:last-child {
            margin-bottom: 0;
        }
        
        .info-item-compact {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            min-width: 48%;
            font-size: 0.85rem;
        }
        
        .info-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .info-label {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
        }
        
        .card-footer {
            background: #f8f9fa;
            padding: 15px;
            border-top: 1px solid #eee;
        }
        
        .footer-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .footer-left, .footer-right {
            flex: 1;
            display: flex;
            justify-content: flex-start;
        }
        
        .footer-right {
            justify-content: flex-end;
        }
        
        .footer-center {
            flex: 1;
            text-align: center;
        }
        
        .logo-footer {
            font-size: 1rem;
            font-weight: 600;
            color: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .home-link, .like-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 8px 12px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            width: fit-content;
        }
        
        .home-link:hover, .like-button:hover {
            transform: scale(1.05);
        }
        
        .like-button.liked {
            background: #667eea;
            color: white;
        }
        
        .like-button.liked i, .like-button.liked span {
            color: white !important;
        }
        
        .share-actions {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 1000;
        }
        
        .share-btn {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .watermark {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.8);
            z-index: 2;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .share-card {
                max-width: 100%;
            }
            
            .images-grid {
                gap: 8px;
            }
            
            .image-item {
                margin-bottom: 6px;
            }
            
            .brand-info {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .brand-info-compact {
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .info-row {
                flex-direction: row;
                gap: 8px;
                margin-bottom: 6px;
            }
            
            .info-item-compact {
                min-width: 45%;
                justify-content: space-between;
                font-size: 0.75rem;
            }
        }
        
        .share-hint {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: none;
            z-index: 999;
        }
    </style>
    
    <!-- å¼•å…¥å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- å¾®ä¿¡JS-SDK -->
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
</head>
<body>
    <div class="share-card" id="shareCard">
        <div class="card-header">
            <div class="watermark">å—æ„ç§‹æ£ </div>
            <div class="brand-name" id="brandName">åŠ è½½ä¸­...</div>
            <div class="brand-subtitle">æ±‰æ–‡åŒ–å¸ƒæ–™è®¾è®¡</div>
        </div>
        
        <div class="card-body">
            <!-- è®¾è®¡çµæ„Ÿéƒ¨åˆ† -->
            <div class="inspiration-section">
                <div class="section-title">
                    <i class="fas fa-lightbulb"></i>
                    è®¾è®¡çµæ„Ÿ
                </div>
                <div class="inspiration-text" id="inspirationText">åŠ è½½ä¸­...</div>
            </div>
            
            <!-- å¸ƒæ–™ä¿¡æ¯ - ä¼˜åŒ–ç´§å‡‘å¸ƒå±€ -->
            <div class="brand-info-compact" id="brandInfo">
                <div class="info-row">
                    <span class="info-item-compact">
                        <span class="info-label">å¹´ä»½:</span>
                        <span class="info-value" id="yearValue">-</span>
                    </span>
                    <span class="info-item-compact">
                        <span class="info-label">æè´¨:</span>
                        <span class="info-value" id="materialValue">-</span>
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-item-compact">
                        <span class="info-label">ç³»åˆ—:</span>
                        <span class="info-value" id="seriesValue">-</span>
                    </span>
                    <span class="info-item-compact">
                        <span class="info-label">è§„æ ¼:</span>
                        <span class="info-value" id="sizeValue">-</span>
                    </span>
                </div>
            </div>
            
            <!-- å›¾ç‰‡å±•ç¤º -->
            <div class="images-section">
                <div class="section-title">
                    <i class="fas fa-images"></i>
                    äº§å“å›¾ç‰‡
                </div>
                <div class="images-grid" id="imagesGrid">
                    <!-- åŠ¨æ€ç”Ÿæˆå›¾ç‰‡ -->
                </div>
            </div>
        </div>
        
        <div class="card-footer">
            <div class="footer-actions">
                <div class="footer-left">
                    <div class="home-link" onclick="goToHomepage()" style="cursor: pointer;">
                        <i class="fas fa-home" style="font-size: 1rem; color: #667eea;"></i>
                        <span style="margin-left: 5px; font-size: 0.8rem; color: #667eea;">ä¸»é¡µ</span>
                    </div>
                </div>
                <div class="footer-center">
                    <div class="logo-footer">
                        <i class="fas fa-leaf"></i>
                        å—æ„ç§‹æ£ 
                    </div>
                </div>
                <div class="footer-right">
                    <div class="like-button" onclick="likeBrand()" style="cursor: pointer;" id="likeButton">
                        <i class="fas fa-thumbs-up" style="font-size: 1rem;" id="likeIcon"></i>
                        <span style="margin-left: 5px; font-size: 0.8rem;" id="likeText">ç‚¹èµ</span>
                        <span style="margin-left: 3px; font-size: 0.8rem;" id="likeCount">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åˆ†äº«æŒ‰é’® -->
    <div class="share-actions">
        <button class="share-btn" onclick="shareToWechat()" title="åˆ†äº«åˆ°å¾®ä¿¡">
            <i class="fab fa-weixin" style="color: #07c160;"></i>
        </button>
        <button class="share-btn" onclick="downloadCard()" title="ä¿å­˜å›¾ç‰‡">
            <i class="fas fa-download" style="color: #667eea;"></i>
        </button>
        <button class="share-btn" onclick="copyLink()" title="å¤åˆ¶é“¾æ¥">
            <i class="fas fa-link" style="color: #667eea;"></i>
        </button>
    </div>
    
    <!-- é•¿æŒ‰æç¤º -->
    <div class="share-hint" id="shareHint">
        é•¿æŒ‰å›¾ç‰‡ä¿å­˜æˆ–åˆ†äº«åˆ°æœ‹å‹åœˆ
    </div>
    
    <script>
        // é¡µé¢æ•°æ®
        let cardData = {};
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            loadCardData();
            initializeShare();
            showShareHint();
            
            // å¦‚æœURLåŒ…å«debugå‚æ•°ï¼Œæ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('debug') === '1') {
                showDebugInfo();
            }
        });
        
        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶é‡æ–°è®¾ç½®åˆ†äº«
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && typeof setupWechatShare === 'function') {
                console.log('é¡µé¢é‡æ–°å¯è§ï¼Œé‡æ–°è®¾ç½®å¾®ä¿¡åˆ†äº«');
                setTimeout(setupWechatShare, 100);
            }
        });
        
        // URLå˜åŒ–æ—¶é‡æ–°è®¾ç½®åˆ†äº«
        window.addEventListener('popstate', function() {
            if (typeof setupWechatShare === 'function') {
                console.log('URLå˜åŒ–ï¼Œé‡æ–°è®¾ç½®å¾®ä¿¡åˆ†äº«');
                setTimeout(setupWechatShare, 100);
            }
        });
        
        // åŠ è½½å¡ç‰‡æ•°æ®
        function loadCardData() {
            const urlParams = new URLSearchParams(window.location.search);
            const brandName = urlParams.get('brand') || 'æœªçŸ¥å“ç‰Œ';
            
            // æ¨¡æ‹Ÿæ•°æ®ï¼ˆå®é™…åº”è¯¥ä»APIè·å–ï¼‰
            cardData = {
                brand_name: decodeURIComponent(brandName),
                inspiration_origin: 'è¿™æ¬¾å¸ƒæ–™è®¾è®¡çµæ„Ÿæ¥æºäºä¼ ç»Ÿæ±‰æ–‡åŒ–ä¸ç°ä»£ç¾å­¦çš„å®Œç¾èåˆï¼Œå±•ç°äº†ä¸œæ–¹éŸµå‘³çš„ç‹¬ç‰¹é­…åŠ›ã€‚',
                year: '2024',
                material: 'æ£‰éº»',
                theme_series: 'ç»å…¸ç³»åˆ—',
                print_size: 'å¾ªç¯å°èŠ±æ–™',
                images: [],
                card_url: window.location.href
            };
            
            // æ›´æ–°é¡µé¢å†…å®¹
            updatePageContent();
            
            // ä»APIè·å–å®é™…æ•°æ®
            fetchBrandData(brandName);
        }
        
        // ä»APIè·å–å“ç‰Œæ•°æ®
        function fetchBrandData(brandName) {
            console.log('å°è¯•è·å–å“ç‰Œæ•°æ®:', brandName);
            
            // æ ¹æ®å½“å‰åŸŸååŠ¨æ€æ„å»ºAPI URL
            const currentHost = window.location.hostname;
            let apiBaseUrl = '';
            
            if (currentHost === '121.36.205.70') {
                // IPè®¿é—®æ—¶ä½¿ç”¨IPåœ°å€çš„åç«¯ç«¯å£
                apiBaseUrl = 'http://121.36.205.70:5001';
            } else if (currentHost.includes('nanyiqiutang.cn') || currentHost.includes('chenxiaoshivivid.com')) {
                // åŸŸåè®¿é—®æ—¶ä½¿ç”¨åŸŸå
                apiBaseUrl = `http://${currentHost}`;
            } else {
                // å…¶ä»–æƒ…å†µï¼ˆå¦‚æœ¬åœ°å¼€å‘ï¼‰ä½¿ç”¨ç›¸å¯¹è·¯å¾„
                apiBaseUrl = '';
            }
            
            // æ„å»ºå®Œæ•´çš„API URL
            const shareApiUrl = `${apiBaseUrl}/api/share/card/${brandName}`;
            
            console.log('ä½¿ç”¨API URL:', shareApiUrl);
            
            fetch(shareApiUrl)
                .then(response => response.json())
                .then(data => {
                    console.log('APIå“åº”:', data);
                    if (data.success && data.card_data) {
                        console.log('æˆåŠŸè·å–å¡ç‰‡æ•°æ®:', data.card_data);
                        cardData = {
                            ...cardData,
                            brand_name: data.card_data.brand_name,
                            year: data.card_data.year,
                            material: data.card_data.material,
                            theme_series: data.card_data.theme_series,
                            print_size: data.card_data.print_size,
                            inspiration: data.card_data.inspiration_origin || 'æ±‰æ–‡åŒ–å¸ƒæ–™è®¾è®¡ç²¾é«“',
                            images: data.card_data.images || []
                        };
                        updatePageContent();
                        initializeImages();
                        // å¦‚æœAPIè¿”å›äº†ç‚¹èµæ•°ï¼Œå…ˆè®¾ç½®å®ƒ
                        if (typeof data.card_data.like_count !== 'undefined') {
                            document.getElementById('likeCount').textContent = data.card_data.like_count;
                        }
                        loadLikeStatus();
                    } else {
                        console.error('APIè¿”å›å¤±è´¥:', data.error || 'æœªçŸ¥é”™è¯¯');
                        // ä½¿ç”¨é»˜è®¤æ•°æ®ï¼Œä½†è®¾ç½®æ­£ç¡®çš„å“ç‰Œå
                        cardData.brand_name = brandName;
                        updatePageContent();
                        loadLikeStatus();
                    }
                })
                .catch(error => {
                    console.error('è·å–æ•°æ®å¤±è´¥:', error);
                    // ä½¿ç”¨é»˜è®¤æ•°æ®ï¼Œä½†è®¾ç½®æ­£ç¡®çš„å“ç‰Œå
                    cardData.brand_name = brandName;
                    updatePageContent();
                });
        }
        
        // æ›´æ–°é¡µé¢å†…å®¹
        function updatePageContent() {
            console.log('æ›´æ–°é¡µé¢å†…å®¹:', cardData);
            
            // è·å–å“ç‰Œåï¼Œæ”¯æŒå¤šç§å­—æ®µå
            const brandName = cardData.brand_name || cardData.name || 'å—æ„ç§‹æ£ ';
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜å’Œå“ç‰Œå
            document.title = `${brandName} - å—æ„ç§‹æ£ `;
            const brandNameElement = document.getElementById('brandName');
            if (brandNameElement) brandNameElement.textContent = brandName;
            
            // æ›´æ–°è®¾è®¡çµæ„Ÿ
            const inspiration = cardData.inspiration || cardData.inspiration_origin || 'è¿™æ¬¾å¸ƒæ–™è®¾è®¡çµæ„Ÿæ¥æºäºä¼ ç»Ÿæ±‰æ–‡åŒ–ä¸ç°ä»£ç¾å­¦çš„å®Œç¾èåˆï¼Œå±•ç°äº†ä¸œæ–¹éŸµå‘³çš„ç‹¬ç‰¹é­…åŠ›ã€‚';
            const inspirationElement = document.getElementById('inspirationText');
            if (inspirationElement) {
                // å¤„ç†markdownæ ¼å¼æ–‡æœ¬
                inspirationElement.innerHTML = parseMarkdown(inspiration);
            }
            
            // æ›´æ–°åŸºæœ¬ä¿¡æ¯
            const yearElement = document.getElementById('yearValue');
            if (yearElement) yearElement.textContent = (cardData.year || '2024') + 'å¹´';
            
            const materialElement = document.getElementById('materialValue');
            if (materialElement) materialElement.textContent = cardData.material || 'æ£‰éº»';
            
            const seriesElement = document.getElementById('seriesValue');
            if (seriesElement) seriesElement.textContent = cardData.theme_series || cardData.series || 'ç»å…¸ç³»åˆ—';
            
            const sizeElement = document.getElementById('sizeValue');
            if (sizeElement) sizeElement.textContent = cardData.print_size || cardData.size || 'å¾ªç¯å°èŠ±æ–™';
            
            // å†…å®¹æ›´æ–°åé‡æ–°è®¾ç½®å¾®ä¿¡åˆ†äº«
            if (typeof setupWechatShare === 'function') {
                setupWechatShare();
            }
        }
        
        // åˆå§‹åŒ–å›¾ç‰‡å±•ç¤º
        function initializeImages() {
            const imagesGrid = document.getElementById('imagesGrid');
            const imageTypes = ['æ¦‚å¿µå›¾', 'è®¾è®¡å›¾', 'å¸ƒæ–™å›¾', 'æˆè¡£å›¾', 'æ¨¡ç‰¹å›¾', 'ä¹°å®¶ç§€å›¾'];
            
            // æ¸…ç©ºç°æœ‰å›¾ç‰‡
            imagesGrid.innerHTML = '';
            
            // æŒ‰ç±»å‹ç­›é€‰å¹¶æ˜¾ç¤ºå›¾ç‰‡
            const typeImageMap = {};
            cardData.images.forEach(image => {
                if (imageTypes.includes(image.image_type)) {
                    if (!typeImageMap[image.image_type]) {
                        typeImageMap[image.image_type] = image;
                    }
                }
            });
            
            // æŒ‰æŒ‡å®šé¡ºåºæ˜¾ç¤ºå›¾ç‰‡
            imageTypes.forEach(type => {
                if (typeImageMap[type]) {
                    const image = typeImageMap[type];
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item';
                    
                    // å¤„ç†å›¾ç‰‡URL
                    let imageUrl = '';
                    if (image.medium_url && image.medium_url.startsWith('http')) {
                        imageUrl = image.medium_url;
                    } else if (image.url && image.url.startsWith('http')) {
                        imageUrl = image.url;
                    } else if (image.relative_path) {
                        const encodedPath = image.relative_path.split('/').map(part => encodeURIComponent(part)).join('/');
                        imageUrl = `/static/images/${encodedPath}`;
                    } else {
                        imageUrl = `/static/images/${image.filename || 'placeholder.jpg'}`;
                    }
                    
                    imageItem.innerHTML = `
                        <img src="${imageUrl}" alt="${image.image_type}" onerror="this.parentElement.style.display='none'">
                        <div class="image-type">${image.image_type}</div>
                    `;
                    imagesGrid.appendChild(imageItem);
                }
            });
        }
        
        // åˆå§‹åŒ–åˆ†äº«åŠŸèƒ½
        function initializeShare() {
            // è®¾ç½®å¾®ä¿¡åˆ†äº«
            setupWechatShare();
            // é•¿æŒ‰ä¿å­˜å›¾ç‰‡
            let longPressTimer;
            const shareCard = document.getElementById('shareCard');
            
            shareCard.addEventListener('touchstart', function() {
                longPressTimer = setTimeout(function() {
                    // é•¿æŒ‰é€»è¾‘
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                    shareToWechat();
                }, 800);
            });
            
            shareCard.addEventListener('touchend', function() {
                clearTimeout(longPressTimer);
            });
            
            shareCard.addEventListener('touchmove', function() {
                clearTimeout(longPressTimer);
            });
        }
        
        // åˆ†äº«åˆ°å¾®ä¿¡
        function shareToWechat() {
            if (/MicroMessenger/i.test(navigator.userAgent)) {
                // åœ¨å¾®ä¿¡ä¸­ï¼Œæç¤ºç”¨æˆ·ç‚¹å‡»å³ä¸Šè§’åˆ†äº«
                showToast('è¯·ç‚¹å‡»å³ä¸Šè§’"..."æŒ‰é’®åˆ†äº«');
            } else {
                // å°è¯•ä½¿ç”¨Web Share API
                if (navigator.share) {
                    navigator.share({
                        title: cardData.brand_name + ' - å—æ„ç§‹æ£ ',
                        text: cardData.inspiration_origin,
                        url: cardData.card_url
                    }).catch(err => {
                        console.log('åˆ†äº«å¤±è´¥:', err);
                        copyLink();
                    });
                } else {
                    copyLink();
                }
            }
        }
        
        // ä¸‹è½½å¡ç‰‡
        function downloadCard() {
            // ä½¿ç”¨html2canvasåº“å°†å¡ç‰‡è½¬æ¢ä¸ºå›¾ç‰‡
            if (window.html2canvas) {
                html2canvas(document.getElementById('shareCard')).then(canvas => {
                    const link = document.createElement('a');
                    link.download = cardData.brand_name + '-å¸ƒæ–™å¡ç‰‡.png';
                    link.href = canvas.toDataURL();
                    link.click();
                    showToast('å›¾ç‰‡å·²ä¿å­˜');
                }).catch(err => {
                    console.error('ä¸‹è½½å¤±è´¥:', err);
                    showToast('ä¸‹è½½å¤±è´¥ï¼Œè¯·é•¿æŒ‰å¡ç‰‡ä¿å­˜å›¾ç‰‡');
                });
            } else {
                showToast('è¯·é•¿æŒ‰å¡ç‰‡ä¿å­˜å›¾ç‰‡');
            }
        }
        
        // å¤åˆ¶é“¾æ¥
        function copyLink() {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(cardData.card_url).then(() => {
                    showToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    fallbackCopyLink();
                });
            } else {
                fallbackCopyLink();
            }
        }
        
        // é™çº§å¤åˆ¶é“¾æ¥
        function fallbackCopyLink() {
            const textArea = document.createElement('textarea');
            textArea.value = cardData.card_url;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (err) {
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
            }
            document.body.removeChild(textArea);
        }
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 15px 25px;
                border-radius: 25px;
                font-size: 0.9rem;
                z-index: 9999;
                animation: fadeInOut 2s ease-in-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 2000);
        }
        
        // æ˜¾ç¤ºåˆ†äº«æç¤º
        function showShareHint() {
            setTimeout(() => {
                const hint = document.getElementById('shareHint');
                if (hint) {
                    hint.style.display = 'block';
                    setTimeout(() => {
                        hint.style.display = 'none';
                    }, 3000);
                }
            }, 1000);
        }
        
        // è·³è½¬åˆ°ä¸»é¡µ
        function goToHomepage() {
            window.open(window.location.origin, '_blank');
            showToast('æ­£åœ¨è·³è½¬åˆ°ä¸»é¡µ...');
        }
        
        // ç‚¹èµåŠŸèƒ½
        function likeBrand() {
            const brandName = cardData.brand_name || 'æœªçŸ¥å“ç‰Œ';
            const likeButton = document.getElementById('likeButton');
            const likeIcon = document.getElementById('likeIcon');
            const likeText = document.getElementById('likeText');
            const likeCount = document.getElementById('likeCount');
            
            // å¦‚æœå·²ç»ç‚¹èµè¿‡ï¼Œæç¤ºç”¨æˆ·
            if (likeButton.classList.contains('liked')) {
                showToast('æ‚¨å·²ç»ç‚¹èµè¿‡äº†ï¼');
                return;
            }
            
            // æ ¹æ®å½“å‰åŸŸååŠ¨æ€æ„å»ºAPI URL
            const currentHost = window.location.hostname;
            let apiBaseUrl = '';
            
            if (currentHost === '121.36.205.70') {
                // IPè®¿é—®æ—¶ä½¿ç”¨IPåœ°å€çš„åç«¯ç«¯å£
                apiBaseUrl = 'http://121.36.205.70:5001';
            } else if (currentHost.includes('nanyiqiutang.cn') || currentHost.includes('chenxiaoshivivid.com')) {
                // åŸŸåè®¿é—®æ—¶ä½¿ç”¨åŸŸå
                apiBaseUrl = `http://${currentHost}`;
            } else {
                // å…¶ä»–æƒ…å†µï¼ˆå¦‚æœ¬åœ°å¼€å‘ï¼‰ä½¿ç”¨ç›¸å¯¹è·¯å¾„
                apiBaseUrl = '';
            }
            
            // å–æ¶ˆç‚¹èµAPI
            const likeApiUrl = `${apiBaseUrl}/api/like/card/${encodeURIComponent(brandName)}`;
            
            fetch(likeApiUrl, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // æ›´æ–°UIçŠ¶æ€
                        likeButton.classList.remove('liked');
                        likeIcon.className = 'fas fa-thumbs-up';
                        likeText.textContent = 'ç‚¹èµ';
                        likeCount.textContent = data.like_count;
                        showToast(data.message);
                    } else {
                        showToast(data.message || 'å–æ¶ˆç‚¹èµå¤±è´¥');
                    }
                })
                .catch(error => {
                    console.error('å–æ¶ˆç‚¹èµå¤±è´¥:', error);
                    showToast('å–æ¶ˆç‚¹èµå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                });
        }
        
        // è·å–ç‚¹èµçŠ¶æ€
        function loadLikeStatus() {
            const brandName = cardData.brand_name || 'æœªçŸ¥å“ç‰Œ';
            
            // æ ¹æ®å½“å‰åŸŸååŠ¨æ€æ„å»ºAPI URL
            const currentHost = window.location.hostname;
            let apiBaseUrl = '';
            
            if (currentHost === '121.36.205.70') {
                // IPè®¿é—®æ—¶ä½¿ç”¨IPåœ°å€çš„åç«¯ç«¯å£
                apiBaseUrl = 'http://121.36.205.70:5001';
            } else if (currentHost.includes('nanyiqiutang.cn') || currentHost.includes('chenxiaoshivivid.com')) {
                // åŸŸåè®¿é—®æ—¶ä½¿ç”¨åŸŸå
                apiBaseUrl = `http://${currentHost}`;
            } else {
                // å…¶ä»–æƒ…å†µï¼ˆå¦‚æœ¬åœ°å¼€å‘ï¼‰ä½¿ç”¨ç›¸å¯¹è·¯å¾„
                apiBaseUrl = '';
            }
            
            const likeApiUrl = `${apiBaseUrl}/api/like/card/${encodeURIComponent(brandName)}`;
            
            fetch(likeApiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const likeButton = document.getElementById('likeButton');
                        const likeIcon = document.getElementById('likeIcon');
                        const likeText = document.getElementById('likeText');
                        const likeCount = document.getElementById('likeCount');
                        
                        // æ›´æ–°ç‚¹èµæ•°
                        likeCount.textContent = data.like_count || 0;
                        
                        // å¦‚æœå·²ç»ç‚¹èµè¿‡ï¼Œæ›´æ–°UIçŠ¶æ€
                        if (data.liked) {
                            likeButton.classList.add('liked');
                            likeIcon.className = 'fas fa-thumbs-up';
                            likeText.textContent = 'å·²èµ';
                        }
                    }
                })
                .catch(error => {
                    console.error('è·å–ç‚¹èµçŠ¶æ€å¤±è´¥:', error);
                });
        }
        
        // ç®€å•çš„markdownè§£æå‡½æ•°
        function parseMarkdown(text) {
            if (!text) return text;
            
            return text
                // ç²—ä½“ **text** æˆ– __text__
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<strong>$1</strong>')
                // æ–œä½“ *text* æˆ– _text_
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                // æ¢è¡Œ
                .replace(/\n/g, '<br>')
                // ç®€å•çš„æ®µè½å¤„ç†
                .replace(/\n\n+/g, '</p><p>')
                // åŒ…è£…æ®µè½ï¼ˆå¦‚æœæœ‰å¤šä¸ªæ®µè½ï¼‰
                .replace(/^(.*)$/s, text.includes('</p><p>') ? '<p>$1</p>' : '$1');
        }
        
        // æ£€æµ‹æ˜¯å¦ä¸ºå¾®ä¿¡æµè§ˆå™¨
        function isWechatBrowser() {
            const ua = navigator.userAgent.toLowerCase();
            return ua.includes('micromessenger');
        }
        
        // è®¾ç½®å¾®ä¿¡åˆ†äº«
        function setupWechatShare() {
            // æ›´æ–°metaæ ‡ç­¾
            updateMetaTags();
            
            // å¦‚æœåœ¨å¾®ä¿¡æµè§ˆå™¨ä¸­ï¼Œé…ç½®å¾®ä¿¡åˆ†äº«
            if (isWechatBrowser() && typeof wx !== 'undefined') {
                console.log('æ£€æµ‹åˆ°å¾®ä¿¡æµè§ˆå™¨ï¼Œé…ç½®å¾®ä¿¡åˆ†äº«');
                
                // é…ç½®å¾®ä¿¡åˆ†äº«
                wx.config({
                    debug: false,
                    appId: 'dummy_app_id', // è¿™é‡Œéœ€è¦çœŸå®çš„appId
                    timestamp: Math.floor(Date.now() / 1000),
                    nonceStr: 'dummy_nonce_str',
                    signature: 'dummy_signature',
                    jsApiList: [
                        'updateAppMessageShareData',
                        'updateTimelineShareData',
                        'onMenuShareTimeline',
                        'onMenuShareAppMessage'
                    ]
                });
                
                wx.ready(function() {
                    console.log('å¾®ä¿¡JS-SDKåˆå§‹åŒ–æˆåŠŸ');
                    configureWechatShare();
                });
                
                wx.error(function(res) {
                    console.log('å¾®ä¿¡JS-SDKåˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨Metaæ ‡ç­¾æ–¹å¼:', res);
                    // å³ä½¿JS-SDKå¤±è´¥ï¼Œmetaæ ‡ç­¾ä»ç„¶æœ‰æ•ˆ
                });
            } else {
                console.log('éå¾®ä¿¡æµè§ˆå™¨æˆ–JS-SDKæœªåŠ è½½ï¼Œä½¿ç”¨Metaæ ‡ç­¾æ–¹å¼');
            }
        }
        
        // é…ç½®å¾®ä¿¡åˆ†äº«å†…å®¹
        function configureWechatShare() {
            const shareData = getShareData();
            
            // æ–°ç‰ˆAPI
            if (wx.updateAppMessageShareData) {
                wx.updateAppMessageShareData({
                    title: shareData.title,
                    desc: shareData.desc,
                    link: shareData.link,
                    imgUrl: shareData.imgUrl,
                    success: function() {
                        console.log('å¾®ä¿¡åˆ†äº«ç»™æœ‹å‹é…ç½®æˆåŠŸ');
                    },
                    fail: function(err) {
                        console.log('å¾®ä¿¡åˆ†äº«ç»™æœ‹å‹é…ç½®å¤±è´¥:', err);
                    }
                });
            }
            
            if (wx.updateTimelineShareData) {
                wx.updateTimelineShareData({
                    title: shareData.title,
                    link: shareData.link,
                    imgUrl: shareData.imgUrl,
                    success: function() {
                        console.log('å¾®ä¿¡åˆ†äº«åˆ°æœ‹å‹åœˆé…ç½®æˆåŠŸ');
                    },
                    fail: function(err) {
                        console.log('å¾®ä¿¡åˆ†äº«åˆ°æœ‹å‹åœˆé…ç½®å¤±è´¥:', err);
                    }
                });
            }
            
            // å…¼å®¹æ—§ç‰ˆAPI
            if (wx.onMenuShareAppMessage) {
                wx.onMenuShareAppMessage(shareData);
            }
            
            if (wx.onMenuShareTimeline) {
                wx.onMenuShareTimeline({
                    title: shareData.title,
                    link: shareData.link,
                    imgUrl: shareData.imgUrl
                });
            }
        }
        
        // è·å–åˆ†äº«æ•°æ®
        function getShareData() {
            const brandName = cardData.brand_name || 'å—æ„ç§‹æ£ å¸ƒæ–™';
            const inspiration = cardData.inspiration || cardData.inspiration_origin || 'ä¼ æ‰¿ç»å…¸ï¼Œåˆ›æ–°æœªæ¥ - æ±‰æ–‡åŒ–å¸ƒæ–™è®¾è®¡çš„è‰ºæœ¯ä¹‹ç¾';
            
            // è·å–ç¬¬ä¸€å¼ å›¾ç‰‡ä½œä¸ºåˆ†äº«å›¾ç‰‡
            let shareImage = 'http://products.nanyiqiutang.cn/static/images/ç‰¡ä¸¹äº­æ¦‚å¿µå›¾.jpg';
            if (cardData.images && cardData.images.length > 0) {
                const firstImage = cardData.images[0];
                if (firstImage.medium_url && firstImage.medium_url.startsWith('http')) {
                    shareImage = firstImage.medium_url;
                } else if (firstImage.url && firstImage.url.startsWith('http')) {
                    shareImage = firstImage.url;
                } else if (firstImage.relative_path) {
                    const encodedPath = firstImage.relative_path.split('/').map(part => encodeURIComponent(part)).join('/');
                    shareImage = `http://products.nanyiqiutang.cn/static/images/${encodedPath}`;
                }
            }
            
            return {
                title: `${brandName} - å—æ„ç§‹æ£ `,
                desc: inspiration.substring(0, 100) + (inspiration.length > 100 ? '...' : ''),
                link: window.location.href,
                imgUrl: shareImage,
                success: function() {
                    console.log('åˆ†äº«æˆåŠŸ');
                },
                cancel: function() {
                    console.log('å–æ¶ˆåˆ†äº«');
                }
            };
        }
        
        // æ›´æ–°metaæ ‡ç­¾
        function updateMetaTags() {
            const shareData = getShareData();
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            document.title = shareData.title;
            const pageTitleElement = document.getElementById('pageTitle');
            if (pageTitleElement) {
                pageTitleElement.textContent = shareData.title;
            }
            
            // æ›´æ–°æˆ–åˆ›å»ºmetaæ ‡ç­¾
            const metaTags = [
                { property: 'og:title', content: shareData.title },
                { property: 'og:description', content: shareData.desc },
                { property: 'og:url', content: shareData.link },
                { property: 'og:image', content: shareData.imgUrl },
                { name: 'twitter:title', content: shareData.title },
                { name: 'twitter:description', content: shareData.desc },
                { name: 'twitter:image', content: shareData.imgUrl },
                { itemprop: 'name', content: shareData.title },
                { itemprop: 'description', content: shareData.desc },
                { itemprop: 'image', content: shareData.imgUrl },
                { name: 'wechat:title', content: shareData.title },
                { name: 'wechat:desc', content: shareData.desc },
                { name: 'wechat:imgUrl', content: shareData.imgUrl },
                { name: 'wechat:link', content: shareData.link }
            ];
            
            metaTags.forEach(tag => {
                let selector = '';
                if (tag.property) {
                    selector = `meta[property="${tag.property}"]`;
                } else if (tag.name) {
                    selector = `meta[name="${tag.name}"]`;
                } else if (tag.itemprop) {
                    selector = `meta[itemprop="${tag.itemprop}"]`;
                }
                
                let metaElement = document.querySelector(selector);
                if (metaElement) {
                    metaElement.setAttribute('content', tag.content);
                } else {
                    metaElement = document.createElement('meta');
                    if (tag.property) metaElement.setAttribute('property', tag.property);
                    if (tag.name) metaElement.setAttribute('name', tag.name);
                    if (tag.itemprop) metaElement.setAttribute('itemprop', tag.itemprop);
                    metaElement.setAttribute('content', tag.content);
                    document.head.appendChild(metaElement);
                }
            });
        }
        
        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function showDebugInfo() {
            const debugPanel = document.createElement('div');
            debugPanel.id = 'debug-panel';
            debugPanel.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                width: 300px;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 15px;
                border-radius: 10px;
                font-size: 12px;
                z-index: 10000;
                max-height: 400px;
                overflow-y: auto;
            `;
            
            const isWeChat = isWechatBrowser();
            const hasWxSDK = typeof wx !== 'undefined';
            
            debugPanel.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 10px;">ğŸ› è°ƒè¯•ä¿¡æ¯</div>
                <div>æµè§ˆå™¨ï¼š${isWeChat ? 'âœ… å¾®ä¿¡' : 'âŒ éå¾®ä¿¡'}</div>
                <div>å¾®ä¿¡SDKï¼š${hasWxSDK ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}</div>
                <div>é¡µé¢æ ‡é¢˜ï¼š${document.title}</div>
                <div>å½“å‰URLï¼š${window.location.href}</div>
                <div style="margin-top: 10px;">
                    <button onclick="testShareConfig()" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">æµ‹è¯•åˆ†äº«é…ç½®</button>
                    <button onclick="document.getElementById('debug-panel').remove()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-left: 5px;">å…³é—­</button>
                </div>
                <div id="debug-log" style="margin-top: 10px; max-height: 200px; overflow-y: auto; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 5px;"></div>
            `;
            
            document.body.appendChild(debugPanel);
            
            // é‡å†™console.logä»¥æ˜¾ç¤ºåœ¨è°ƒè¯•é¢æ¿ä¸­
            const originalLog = console.log;
            console.log = function(...args) {
                originalLog.apply(console, args);
                const debugLog = document.getElementById('debug-log');
                if (debugLog) {
                    const logEntry = document.createElement('div');
                    logEntry.textContent = args.join(' ');
                    logEntry.style.marginBottom = '2px';
                    debugLog.appendChild(logEntry);
                    debugLog.scrollTop = debugLog.scrollHeight;
                }
            };
        }
        
        // æµ‹è¯•åˆ†äº«é…ç½®
        function testShareConfig() {
            const debugLog = document.getElementById('debug-log');
            if (debugLog) {
                debugLog.innerHTML = '';
            }
            
            console.log('=== åˆ†äº«é…ç½®æµ‹è¯• ===');
            console.log('æµè§ˆå™¨UA:', navigator.userAgent);
            console.log('æ˜¯å¦å¾®ä¿¡æµè§ˆå™¨:', isWechatBrowser());
            console.log('å¾®ä¿¡SDKçŠ¶æ€:', typeof wx !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½');
            
            const shareData = getShareData();
            console.log('åˆ†äº«æ•°æ®:', shareData);
            
            // æ£€æŸ¥metaæ ‡ç­¾
            const metaTags = [
                'og:title', 'og:description', 'og:image', 'og:url',
                'twitter:title', 'twitter:description', 'twitter:image',
                'wechat:title', 'wechat:desc', 'wechat:imgUrl'
            ];
            
            console.log('=== Metaæ ‡ç­¾æ£€æŸ¥ ===');
            metaTags.forEach(tag => {
                const element = document.querySelector(`meta[property="${tag}"], meta[name="${tag}"]`);
                if (element) {
                    console.log(`${tag}: ${element.getAttribute('content')}`);
                } else {
                    console.log(`${tag}: æœªæ‰¾åˆ°`);
                }
            });
            
            if (isWechatBrowser() && typeof wx !== 'undefined') {
                console.log('=== å¾®ä¿¡åˆ†äº«æµ‹è¯• ===');
                setupWechatShare();
            }
        }
    </script>
    
    <!-- html2canvasåº“ç”¨äºå°†å¡ç‰‡è½¬æ¢ä¸ºå›¾ç‰‡ -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</body>
</html>