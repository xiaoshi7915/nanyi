<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>南意秋棠 - 传统美学设计</title>
    
    <!-- 微信分享优化 -->
    <meta name="description" content="传承经典 美美与共 - 古典美学设计，望君着美于裳，专业的汉服面料设计与制作">
    <meta name="keywords" content="南意秋棠,汉服,汉文化,布料设计,传统文化,古风,面料">
    <meta name="author" content="南意秋棠">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="http://products.nanyiqiutang.cn/" />
    <meta property="og:title" content="南意秋棠 - 传统美学设计" />
    <meta property="og:description" content="传承经典 美美与共 - 古典美学设计，望君着美于裳" />
    <meta property="og:image" content="http://products.nanyiqiutang.cn/static/images/牡丹亭/牡丹亭-概念图-01.jpg" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:site_name" content="南意秋棠" />
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="http://products.nanyiqiutang.cn/">
    <meta property="twitter:title" content="南意秋棠 - 传统美学设计">
    <meta property="twitter:description" content="传承经典 美美与共 - 古典美学设计，望君着美于裳">
    <meta property="twitter:image" content="http://products.nanyiqiutang.cn/static/images/牡丹亭/牡丹亭-概念图-01.jpg">
    
    <!-- 微信分享专用 -->
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <!-- 微信分享配置 -->
    <meta name="weixin:timeline_title" content="南意秋棠 - 传统美学设计" />
    <meta name="weixin:appmsg_title" content="南意秋棠 - 传统美学设计" />
    <meta name="weixin:appmsg_desc" content="传承经典 美美与共 - 古典美学设计，望君着美于裳" />
    <meta name="weixin:timeline_desc" content="传承经典 美美与共 - 古典美学设计，望君着美于裳" />
    <meta name="weixin:img_url" content="http://products.nanyiqiutang.cn/static/images/牡丹亭/牡丹亭-概念图-01.jpg" />
    
    <!-- 微信JS-SDK -->
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    
    <!-- Vue.js 3 生产版本 -->
    <script src="static/lib/vue.global.prod.js"></script>
    
    <!-- 引入图标库 -->
    <link rel="stylesheet" href="static/lib/all.min.css">
    
    <!-- 引入样式文件 -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="static/css/responsive.css">
    
    <!-- 引入性能优化配置 -->
    <script src="js/performance-config.js"></script>
    
    <!-- 引入优化的缓存管理器 -->
    <script>
        /**
         * 缓存管理器已移动到 performance-config.js 文件中
         * 这里保留注释以便理解
         */

        // 创建全局优化缓存管理器实例
        // 创建增强的缓存管理器实例
        window.cacheManager = new EnhancedCacheManager();
        
        // 启动性能监控
        window.performanceMonitor = new PerformanceMonitor();
    </script>
    
    <!-- 引入API客户端 -->
    <!-- 恢复使用正式API文件 -->
    <script src="js/api.js"></script>
    <!-- <script src="js/components.js"></script> -->
    <!-- <script src="static/js/main.js"></script> -->
</head>
<body>
    <div id="app">
        <!-- 头部 -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <!-- 可点击的logo，跳转到淘宝店铺 -->
                    <a href="https://shop357296168.taobao.com/?spm=a21n57.shop_search.0.0.1ad93904ohsQt4" 
                       target="_blank" 
                       class="logo-link"
                       @click="handleLogoClick">
                        <div class="logo">
                            <i class="fas fa-leaf"></i>
                            <span>南意秋棠</span>
                        </div>
                    </a>
                    <!-- 右侧图标 -->
                    <div class="header-actions">
                        <a href="https://weidian.com/?userid=1330457134&distributorid=142259736&share_relation=eae4bd30b7458ac1_142259736_1&wfr=h5direct_wxh5" 
                           target="_blank" 
                           class="header-icon" 
                           title="微店">
                            <i class="fas fa-store"></i>
                        </a>
                        <button @click="openCustomerService" class="header-icon" title="智能客服">
                            <i class="fas fa-comments"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- 英雄横幅区 -->
        <section class="hero-banner">
            <div class="container">
                <div class="hero-content">
                    <h1 class="hero-title">传承经典 美美与共</h1>
                    <p class="hero-subtitle">古典美学设计，望君着美于裳</p>
                </div>
            </div>
        </section>

        <!-- 搜索和筛选区 -->
        <section class="filter-section">
            <div class="container">
                <!-- 搜索栏 -->
                <div class="search-box">
                    <div class="search-input-container">
                        <i class="fas fa-search search-icon"></i>
                        <input 
                            v-model="searchQuery" 
                            type="text" 
                            placeholder="搜索品牌名称、布料材质、主题系列、年份..."
                            class="search-input"
                            @input="filterBrands"
                        >
                    </div>
                    <button @click="performSearch" class="search-btn">
                        搜索
                    </button>
                </div>
                


                <!-- 移动端年份横排筛选 -->
                <div class="mobile-only mobile-year-filter">
                    <div class="year-tags-horizontal">
                        <button 
                            @click="clearAllFilters"
                            :class="['year-tag', { active: !hasAnyActiveFilters() }]"
                        >
                            全部
                        </button>
                        <button 
                            v-for="year in filterOptions.years" 
                            :key="'mobile-year-' + year"
                            @click="toggleFilter('year', year)"
                            :class="['year-tag', { active: activeFilters.year === year }]"
                        >
                            {{ year }}
                        </button>
                    </div>
                </div>
                
                <!-- 桌面端筛选标签 -->
                <div class="filter-sections desktop-only">
                    <!-- 按年份 -->
                    <div class="filter-group">
                        <div class="filter-title">按年份</div>
                        <div class="filter-tags-container">
                            <button 
                                @click="clearFilter('year')"
                                :class="['filter-tag', { active: !activeFilters.year }]"
                            >
                                全部({{ Object.values(brandData).length }})
                            </button>
                            <button 
                                v-for="year in filterOptions.years" 
                                :key="'year-' + year"
                                @click="toggleFilter('year', year)"
                                :class="['filter-tag', { active: activeFilters.year === year }]"
                            >
                                {{ year }}({{ brandCounts.years[year] || 0 }})
                            </button>
                        </div>
                    </div>

                    <!-- 按主题系列 - 仅电脑端显示 -->
                    <div class="filter-group desktop-only">
                        <div class="filter-title">按主题系列</div>
                        <div class="filter-tags-container">
                            <button 
                                @click="clearFilter('theme_series')"
                                :class="['filter-tag', { active: !activeFilters.theme_series }]"
                            >
                                全部({{ Object.values(brandData).length }})
                            </button>
                            <button 
                                v-for="series in filterOptions.theme_series" 
                                :key="'series-' + series"
                                @click="toggleFilter('theme_series', series)"
                                :class="['filter-tag', { 
                                    active: (Array.isArray(activeFilters.theme_series) && activeFilters.theme_series.includes(series)) || 
                                           activeFilters.theme_series === series 
                                }]"
                            >
                                {{ series }}({{ brandCounts.theme_series[series] || 0 }})
                            </button>
                        </div>
                    </div>

                    <!-- 按材质 - 仅电脑端显示 -->
                    <div class="filter-group desktop-only">
                        <div class="filter-title">按材质</div>
                        <div class="filter-tags-container">
                            <button 
                                @click="clearFilter('materials')"
                                :class="['filter-tag', { active: !activeFilters.materials }]"
                            >
                                全部({{ Object.values(brandData).length }})
                            </button>
                            <button 
                                v-for="material in filterOptions.materials" 
                                :key="'material-' + material"
                                @click="toggleFilter('materials', material)"
                                :class="['filter-tag', { 
                                    active: (Array.isArray(activeFilters.materials) && activeFilters.materials.includes(material)) || 
                                           activeFilters.materials === material 
                                }]"
                            >
                                {{ material }}({{ brandCounts.materials[material] || 0 }})
                            </button>
                        </div>
                    </div>

                    <!-- 按印制尺寸 - 仅电脑端显示 -->
                    <div class="filter-group desktop-only">
                        <div class="filter-title">按印制尺寸</div>
                        <div class="filter-tags-container">
                            <button 
                                @click="clearFilter('print_sizes')"
                                :class="['filter-tag', { active: !activeFilters.print_sizes }]"
                            >
                                全部({{ Object.values(brandData).length }})
                            </button>
                            <button 
                                v-for="size in filterOptions.print_sizes" 
                                :key="'size-' + size"
                                @click="toggleFilter('print_sizes', size)"
                                :class="['filter-tag', { 
                                    active: (Array.isArray(activeFilters.print_sizes) && activeFilters.print_sizes.includes(size)) || 
                                           activeFilters.print_sizes === size 
                                }]"
                            >
                                {{ size }}({{ brandCounts.print_sizes[size] || 0 }})
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 主要内容 -->
        <main class="main-content">
            <div class="container">
                <!-- 加载状态 -->
                <div v-if="loading" class="loading">
                    <div class="spinner"></div>
                    <p>加载中...</p>
                </div>

                <!-- 错误状态 -->
                <div v-else-if="error" class="error-state">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3>加载失败</h3>
                    <p>{{ error }}</p>
                    <button @click="loadData" class="retry-btn">重试</button>
                </div>

                <!-- 品牌网格 -->
                <div v-else-if="filteredBrands.length > 0" class="brands-grid">
                    <div 
                        v-for="brand in filteredBrands" 
                        :key="brand.name"
                        class="brand-card"
                        @click="openBrandDetail(brand)"
                    >
                        <div class="brand-image-container">
                            <img 
                                :src="getBrandCoverImage(brand)" 
                                :alt="brand.name"
                                class="brand-image"
                                loading="lazy"
                                @error="handleImageError"
                            >
                        </div>
                        <div class="brand-info">
                            <h3 class="brand-name">{{ brand.name }}</h3>
                            <div class="brand-meta">
                                <div class="meta-tags">
                                    <span v-if="brand.year && brand.year !== 'N/A' && brand.year !== ''" 
                                          class="meta-tag" 
                                          @click.stop="filterByTag('year', brand.year)">{{ brand.year }}年</span>
                                    <span v-if="brand.theme_series && brand.theme_series !== 'N/A' && brand.theme_series !== ''" 
                                          class="meta-tag" 
                                          @click.stop="filterByTag('theme_series', brand.theme_series)">{{ brand.theme_series }}</span>
                                    <span v-if="brand.material && brand.material !== 'N/A' && brand.material !== ''" 
                                          class="meta-tag" 
                                          @click.stop="filterByTag('material', brand.material)">{{ brand.material }}</span>
                                    <span v-if="brand.print_size && brand.print_size !== 'N/A' && brand.print_size !== ''" 
                                          class="meta-tag" 
                                          @click.stop="filterByTag('print_size', brand.print_size)">{{ brand.print_size }}</span>
                                    <span v-if="brand.fabric_type && brand.fabric_type !== 'N/A' && brand.fabric_type !== ''" 
                                          class="meta-tag" 
                                          @click.stop="filterByTag('fabric_type', brand.fabric_type)">{{ brand.fabric_type }}</span>
                                    <span v-if="brand.print_type && brand.print_type !== 'N/A' && brand.print_type !== ''" 
                                          class="meta-tag" 
                                          @click.stop="filterByTag('print_type', brand.print_type)">{{ brand.print_type }}</span>
                                </div>
                                <div class="like-display" @click.stop="toggleHomeLike(brand)" :class="{ liked: brand.user_liked }">
                                    <i class="fas fa-thumbs-up"></i>
                                    <span>{{ brand.like_count || 0 }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 加载更多按钮 -->
                <div v-if="filteredBrands.length > 0 && pagination.hasNext && !isLoadingMore" class="load-more-section">
                    <button @click="loadMore" class="load-more-btn">
                        <i class="fas fa-plus"></i>
                        加载更多 (第{{ pagination.currentPage + 1 }}页)
                    </button>
                    <div class="pagination-info">
                        已显示 {{ filteredBrands.length }} / {{ pagination.totalBrands }} 个品牌
                    </div>
                </div>

                <!-- 加载中状态 -->
                <div v-if="isLoadingMore" class="loading-more">
                    <div class="loading-spinner"></div>
                    <span>正在加载更多...</span>
                </div>

                <!-- 全部加载完成 -->
                <div v-if="filteredBrands.length > 0 && !pagination.hasNext && !isLoadingMore && pagination.totalBrands > 0" class="all-loaded">
                    <i class="fas fa-check-circle"></i>
                    <span>已显示全部 {{ pagination.totalBrands }} 个品牌</span>
                </div>

                <!-- 空状态 -->
                <div v-else-if="!loading && filteredBrands.length === 0" class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3>没有找到匹配的品牌</h3>
                    <p>尝试调整搜索条件或筛选选项</p>
                </div>
            </div>
        </main>

        <!-- 品牌详情模态框 -->
        <div v-if="selectedBrand && showModal" :class="['modal-overlay', { active: showModal }]" @click="closeModal">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h2 class="modal-title">{{ selectedBrand.name || selectedBrand.brand_name }}</h2>
                    <button @click="closeModal" class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- 基本信息 -->
                    <div class="detail-section">
                        <div class="section-header">
                            <h3 class="section-title">基本信息</h3>
                            <!-- 点赞按钮 -->
                            <div class="detail-like-section">
                                <button 
                                    @click="toggleLike" 
                                    :class="['detail-like-btn', { liked: brandLikeStatus.liked, loading: brandLikeStatus.loading }]"
                                    :disabled="brandLikeStatus.loading"
                                >
                                    <i :class="brandLikeStatus.liked ? 'fas fa-thumbs-up' : 'far fa-thumbs-up'"></i>
                                    <span class="like-count">{{ brandLikeStatus.count }}</span>
                                </button>
                            </div>
                        </div>
                        <div class="detail-tags">
                            <span v-if="selectedBrand.year && selectedBrand.year !== 'N/A' && selectedBrand.year !== ''" 
                                  class="detail-tag" 
                                  @click="filterByTag('year', selectedBrand.year)">{{ selectedBrand.year }}年</span>
                            <span v-if="selectedBrand.theme_series && selectedBrand.theme_series !== 'N/A' && selectedBrand.theme_series !== ''" 
                                  class="detail-tag" 
                                  @click="filterByTag('theme_series', selectedBrand.theme_series)">{{ selectedBrand.theme_series }}</span>
                            <span v-if="selectedBrand.material && selectedBrand.material !== 'N/A' && selectedBrand.material !== ''" 
                                  class="detail-tag" 
                                  @click="filterByTag('materials', selectedBrand.material)">{{ selectedBrand.material }}</span>
                            <span v-if="selectedBrand.print_size && selectedBrand.print_size !== 'N/A' && selectedBrand.print_size !== ''" 
                                  class="detail-tag" 
                                  @click="filterByTag('print_sizes', selectedBrand.print_size)">{{ selectedBrand.print_size }}</span>
                        </div>
                    </div>

                    <!-- 设计灵感 -->
                    <div v-if="selectedBrand.inspiration_origin" class="detail-section">
                        <h3 class="section-title">设计灵感</h3>
                        <div class="inspiration-text" v-html="formatMarkdown(selectedBrand.inspiration_origin)"></div>
                    </div>

                    <!-- 按类型分类的图片展示 -->
                    <div v-for="(images, type) in getCategorizedImages()" :key="type" class="detail-section">
                        <h3 class="section-title">{{ type }}</h3>
                        
                        <!-- 按颜色分组显示 -->
                        <div v-for="(colorImages, color) in groupImagesByColor(images)" :key="color" class="color-group">
                            <h4 v-if="Object.keys(groupImagesByColor(images)).length > 1" class="color-title">{{ color }}</h4>
                            <div class="image-gallery">
                                <div 
                                    v-for="image in colorImages" 
                                    :key="image.filename"
                                    class="gallery-item"
                                    @click="openImagePreview(image)"
                                >
                                    <img 
                                        :src="getImageURL(image)" 
                                        :alt="image.filename"
                                        class="gallery-image"
                                        @error="handleImageError"
                                    >
                                    <div class="image-actions">
                                        <button @click.stop="openImagePreview(image)" class="action-btn zoom-btn">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 生成布料卡片按钮区域 -->
                    <div class="modal-actions">
                        <button @click="generateShareCard" class="generate-card-btn">
                            <i class="fas fa-id-card"></i>
                            生成布料卡片
                        </button>
                        <div class="action-hint">
                            生成精美卡片，轻松分享到朋友圈
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图片预览模态框 -->
        <div v-if="previewImage" class="image-preview-overlay" @click="closeImagePreview">
            <div class="image-preview-content" @click.stop>
                <button @click="closeImagePreview" class="preview-close-btn">
                    <i class="fas fa-times"></i>
                </button>
                <img 
                    :src="getImageURL(previewImage)" 
                    :alt="previewImage.filename"
                    class="preview-image"
                    @error="handleImageError"
                >
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        const app = createApp({
            data() {
                return {
                    loading: true,
                    error: null,
                    searchQuery: '',
    
                    activeFilters: {
                        year: null,
                        material: null,
                        theme_series: null,
                        print_size: null
                    },
                    filterOptions: {
                        years: [],
                        materials: [],
                        theme_series: [],
                        print_sizes: []
                    },
                    brandCounts: {},
                    currentFilterCounts: {}, // 当前筛选状态下的数量统计
                    allImages: [],
                    brandData: {},
                    filteredBrands: [],
                    selectedBrand: null,
                    brandImages: [],
                    showModal: false,
                    previewImage: null,
                    
                    // 分页相关数据
                    pagination: {
                        currentPage: 1,
                        perPage: 12,
                        totalBrands: 0,
                        totalPages: 0,
                        hasNext: false,
                        hasPrev: false
                    },
                    isLoadingMore: false,
                    
                    // 确保初始状态正确
                    dataLoaded: false,
                    brandLikeStatus: {
                        liked: false,
                        count: 0,
                        loading: false
                    }
                };
            },
            
            async mounted() {
                try {
                    // 只在调试模式下输出日志
                    if (PerformanceConfig.performanceMonitoring.verboseLogging) {
                        console.log('Vue应用已挂载，开始加载数据...');
                        console.log('当前URL:', window.location.href);
                        console.log('API Base URL:', window.api ? window.api.baseURL : 'API未初始化');
                    }
                    
                    // 检查API是否可用
                    if (!window.api) {
                        console.error('API实例未找到！');
                        this.error = 'API服务未启动，请稍后重试';
                        this.loading = false;
                        return;
                    }
                    
                    await this.loadData();
                    
                    // 添加滚动监听用于自动加载更多
                    window.addEventListener('scroll', this.checkAutoLoad);
                    
                    // 监听缓存更新事件
                    window.addEventListener('cacheDataUpdate', (event) => {
                        const { type, data } = event.detail;
                        if (type === 'brands') {
                            console.log('检测到品牌数据更新，刷新界面');
                            this.allImages = data.images || [];
                            this.brandData = {};
                            if (data.brands) {
                                data.brands.forEach(brand => {
                                    this.brandData[brand.name] = brand;
                                });
                                this.filteredBrands = data.brands;
                                this.generateFilterOptions();
                                this.filterBrands(); // 重新应用筛选
                            }
                        }
                    });
                } catch (error) {
                    console.error('Vue应用挂载失败:', error);
                    this.error = '应用初始化失败，请刷新页面重试';
                    this.loading = false;
                }
            },

            computed: {
                // 已移除hasActiveFilters计算属性，因为不再需要清除筛选功能
            },

            watch: {
                searchQuery() {
                    this.filterBrands();
                }
            },

            methods: {
                async loadData(page = 1, append = false) {
                    if (!append) {
                        this.loading = true;
                        this.error = null;
                    } else {
                        this.isLoadingMore = true;
                    }
                    
                    try {
                        if (PerformanceConfig.performanceMonitoring.verboseLogging) {
                            console.log(`开始加载数据... 页码: ${page}`);
                        }
                        
                        // 使用智能缓存管理器
                        const cacheKey = page === 1 ? 'brands' : `brands_page_${page}`;
                        const cachedData = await window.cacheManager.getOrFetch(
                            cacheKey,
                            async () => {
                                if (PerformanceConfig.performanceMonitoring.verboseLogging) {
                                    console.log('从API获取数据...');
                                }
                                // 添加重试机制
                                for (let retry = 0; retry < 3; retry++) {
                                    try {
                                        // 构建API请求URL
                                        const url = page === 1 ? 
                                            `/images?page=${page}&per_page=${this.pagination.perPage}&load_all=true` : 
                                            `/images?page=${page}&per_page=${this.pagination.perPage}`;
                                        
                                        const response = await window.api.request(url);
                                        if (response && response.success) {
                                            return {
                                                images: response.images || [],
                                                brands: response.brands || [],
                                                pagination: response.pagination || {}
                                            };
                                        }
                                        throw new Error('API响应无效');
                                    } catch (apiError) {
                                        console.warn(`API请求失败 (尝试 ${retry + 1}/3):`, apiError);
                                        if (retry === 2) {
                                            throw apiError;
                                        }
                                        await new Promise(resolve => setTimeout(resolve, 1000));
                                    }
                                }
                            }
                        );
                        
                        if (cachedData) {
                            // 更新分页信息
                            if (cachedData.pagination) {
                                this.pagination = { ...this.pagination, ...cachedData.pagination };
                            }
                            
                            if (page === 1 || !append) {
                                // 第一页或重新加载：替换数据
                                this.allImages = cachedData.images || [];
                                this.brandData = {};
                                this.filteredBrands = [];
                                
                                if (cachedData.brands && cachedData.brands.length > 0) {
                                    cachedData.brands.forEach(brand => {
                                        this.brandData[brand.name] = brand;
                                    });
                                    this.filteredBrands = cachedData.brands;
                                    this.generateFilterOptions();
                                }
                            } else {
                                // 后续页面：追加数据
                                if (cachedData.brands && cachedData.brands.length > 0) {
                                    cachedData.brands.forEach(brand => {
                                        this.brandData[brand.name] = brand;
                                    });
                                    this.filteredBrands = [...this.filteredBrands, ...cachedData.brands];
                                }
                            }
                            
                            this.dataLoaded = true;
                            if (PerformanceConfig.performanceMonitoring.verboseLogging) {
                                console.log('数据加载完成');
                            }
                        } else {
                            throw new Error('数据加载失败');
                        }

                    } catch (error) {
                        console.error('加载数据失败:', error);
                        
                        // 设置友好的错误信息
                        if (error.message.includes('网络') || error.message.includes('连接')) {
                            this.error = '网络连接失败，请检查网络连接';
                        } else if (error.message.includes('API')) {
                            this.error = 'API服务暂时不可用，请稍后重试';
                        } else {
                            this.error = error.message || '加载数据失败，请刷新页面重试';
                        }
                        
                        // 确保有一些默认数据显示，避免完全空白
                        if (!this.filteredBrands || this.filteredBrands.length === 0) {
                            this.filteredBrands = [];
                            this.brandData = {};
                        }
                    } finally {
                        this.loading = false;
                        this.isLoadingMore = false;
                    }
                },

                generateFilterOptions() {
                    // 从品牌数据中提取唯一的筛选选项并统计数量
                    const yearCounts = {};
                    const materialCounts = {};
                    const themeSeriesCounts = {};
                    const printSizeCounts = {};
                    
                    Object.values(this.brandData).forEach(brand => {
                        if (brand.year) {
                            const year = brand.year.toString();
                            yearCounts[year] = (yearCounts[year] || 0) + 1;
                        }
                        
                        // 修改材质处理逻辑：按/分隔符拆分材质
                        if (brand.material) {
                            const materials = brand.material.split('/').map(m => m.trim()).filter(m => m);
                            materials.forEach(material => {
                                materialCounts[material] = (materialCounts[material] || 0) + 1;
                            });
                        }
                        
                        if (brand.theme_series) {
                            themeSeriesCounts[brand.theme_series] = (themeSeriesCounts[brand.theme_series] || 0) + 1;
                        }
                        if (brand.print_size) {
                            printSizeCounts[brand.print_size] = (printSizeCounts[brand.print_size] || 0) + 1;
                        }
                    });
                    
                    // 生成带统计数量的选项（不包含"全部"）
                    this.filterOptions = {
                        years: Object.keys(yearCounts).sort((a, b) => b.localeCompare(a)),
                        materials: Object.keys(materialCounts).sort(),
                        theme_series: Object.keys(themeSeriesCounts).sort(),
                        print_sizes: Object.keys(printSizeCounts).sort()
                    };
                    
                    // 保存统计数量
                    this.brandCounts = {
                        years: yearCounts,
                        materials: materialCounts,
                        theme_series: themeSeriesCounts,
                        print_sizes: printSizeCounts
                    };
                    
                    if (PerformanceConfig.performanceMonitoring.verboseLogging) {
                        console.log('动态生成的筛选选项:', this.filterOptions);
                        console.log('统计数量:', this.brandCounts);
                    }
                },

                processBrandData() {
                    const brands = {};
                    
                    this.allImages.forEach(image => {
                        const brandName = image.brand_name;
                        

                        
                        if (!brands[brandName]) {
                            brands[brandName] = {
                                name: brandName,
                                images: [],
                                year: image.year || null,
                                material: image.material || null,
                                theme_series: image.theme_series || null,
                                print_size: image.print_size || null,
                                inspiration_origin: image.inspiration_origin || `${brandName}的设计灵感来源于传统文化与现代美学的融合。`
                            };
                        }
                        brands[brandName].images.push(image);
                    });

                    this.brandData = brands;
                    this.filteredBrands = Object.values(brands);
                    
                    // 生成筛选选项
                    this.generateFilterOptions();
                },

                filterBrands() {
                    let filtered = Object.values(this.brandData);

                    // 搜索过滤 - 支持多字段搜索
                    if (this.searchQuery.trim()) {
                        const query = this.searchQuery.toLowerCase();
                        filtered = filtered.filter(brand => 
                            brand.name.toLowerCase().includes(query) ||
                            (brand.material && brand.material.toLowerCase().includes(query)) ||
                            (brand.theme_series && brand.theme_series.toLowerCase().includes(query)) ||
                            (brand.print_size && brand.print_size.toLowerCase().includes(query)) ||
                            (brand.year && brand.year.toString().includes(query))
                        );
                    }

                    // 筛选过滤
                    Object.keys(this.activeFilters).forEach(key => {
                        const value = this.activeFilters[key];
                        if (value && value !== null && value !== undefined) {
                            // 映射前端字段名到数据字段名
                            const fieldMap = {
                                'materials': 'material',
                                'print_sizes': 'print_size'
                            };
                            const fieldName = fieldMap[key] || key;
                            
                            if (Array.isArray(value) && value.length > 0) {
                                // 多选模式：品牌必须匹配任一选中的值
                                if (fieldName === 'material') {
                                    // 材质特殊处理：支持/分隔的材质匹配
                                    filtered = filtered.filter(brand => {
                                        if (!brand[fieldName]) return false;
                                        const brandMaterials = brand[fieldName].split('/').map(m => m.trim()).filter(m => m);
                                        return value.some(selectedMaterial => 
                                            brandMaterials.includes(selectedMaterial)
                                        );
                                    });
                                } else {
                                    filtered = filtered.filter(brand => 
                                        brand[fieldName] && value.includes(brand[fieldName])
                                    );
                                }
                            } else if (!Array.isArray(value)) {
                                // 单选模式：品牌必须匹配选中的值
                                if (fieldName === 'year') {
                                    // 年份筛选特殊处理
                                    filtered = filtered.filter(brand => 
                                        brand[fieldName] && brand[fieldName].toString() === value.toString()
                                    );
                                } else if (fieldName === 'material') {
                                    // 材质特殊处理：支持/分隔的材质匹配
                                    filtered = filtered.filter(brand => {
                                        if (!brand[fieldName]) return false;
                                        const brandMaterials = brand[fieldName].split('/').map(m => m.trim()).filter(m => m);
                                        return brandMaterials.includes(value);
                                    });
                                } else {
                                    filtered = filtered.filter(brand => 
                                        brand[fieldName] && brand[fieldName] === value
                                    );
                                }
                            }
                        }
                    });

                    this.filteredBrands = filtered;
                    
                    // 更新筛选后的统计数量
                    this.updateFilterCounts(filtered);
                },
                
                // 更新筛选后的统计数量
                updateFilterCounts(filteredBrands) {
                    const yearCounts = {};
                    const materialCounts = {};
                    const themeSeriesCounts = {};
                    const printSizeCounts = {};
                    
                    // 重新计算当前筛选结果中的数量
                    filteredBrands.forEach(brand => {
                        if (brand.year) {
                            const year = brand.year.toString();
                            yearCounts[year] = (yearCounts[year] || 0) + 1;
                        }
                        // 修改材质计数逻辑：按/分隔符拆分材质
                        if (brand.material) {
                            const materials = brand.material.split('/').map(m => m.trim()).filter(m => m);
                            materials.forEach(material => {
                                materialCounts[material] = (materialCounts[material] || 0) + 1;
                            });
                        }
                        if (brand.theme_series) {
                            themeSeriesCounts[brand.theme_series] = (themeSeriesCounts[brand.theme_series] || 0) + 1;
                        }
                        if (brand.print_size) {
                            printSizeCounts[brand.print_size] = (printSizeCounts[brand.print_size] || 0) + 1;
                        }
                    });
                    
                    // 更新当前筛选状态下的数量统计
                    this.currentFilterCounts = {
                        years: yearCounts,
                        materials: materialCounts,
                        theme_series: themeSeriesCounts,
                        print_sizes: printSizeCounts
                    };
                },

                toggleFilter(type, value) {
                    // 支持多选的筛选类型
                    const multiSelectTypes = ['materials', 'theme_series', 'print_sizes'];
                    
                    if (multiSelectTypes.includes(type)) {
                        // 多选模式：可以同时选择多个值
                        if (!this.activeFilters[type]) {
                            this.activeFilters[type] = [];
                        }
                        
                        const index = this.activeFilters[type].indexOf(value);
                        if (index > -1) {
                            this.activeFilters[type].splice(index, 1);
                            if (this.activeFilters[type].length === 0) {
                                this.activeFilters[type] = null;
                            }
                        } else {
                            this.activeFilters[type].push(value);
                        }
                    } else {
                        // 单选模式：年份只能选择一个
                        if (this.activeFilters[type] === value) {
                            this.activeFilters[type] = null;
                        } else {
                            this.activeFilters[type] = value;
                        }
                    }
                    
                    this.filterBrands();
                },

                clearAllFilters() {
                    this.activeFilters = {
                        year: null,
                        materials: null,
                        theme_series: null,
                        print_sizes: null
                    };
                    this.filterBrands();
                },

                // 搜索功能 - 修复Vue警告
                performSearch() {
                    // 触发搜索过滤，searchQuery的变化已经通过watch监听自动触发了filterBrands
                    this.filterBrands();
                    
                    // 如果有搜索结果，滚动到结果区域
                    if (this.filteredBrands.length > 0) {
                        const resultsSection = document.querySelector('.brands-grid');
                        if (resultsSection) {
                            resultsSection.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'start' 
                            });
                        }
                    }
                },

                // 加载更多数据
                async loadMore() {
                    if (this.isLoadingMore || !this.pagination.hasNext) {
                        return;
                    }
                    
                    const nextPage = this.pagination.currentPage + 1;
                    await this.loadData(nextPage, true);
                },

                // 检查是否需要自动加载更多（滚动到底部时）
                checkAutoLoad() {
                    if (this.isLoadingMore || !this.pagination.hasNext) {
                        return;
                    }
                    
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const windowHeight = window.innerHeight;
                    const documentHeight = document.documentElement.scrollHeight;
                    
                    // 当滚动到距离底部200px时自动加载
                    if (scrollTop + windowHeight >= documentHeight - 200) {
                        this.loadMore();
                    }
                },

                getBrandCoverImage(brand) {
                                    // 定义图片类型优先级顺序：概念图 > 设计图 > 成衣图 > 布料图 > 模特图 > 买家秀图 > 其他
                const priorityOrder = ['概念图', '设计图', '成衣图', '布料图', '模特图', '买家秀图', '其他'];
                    
                    // 按优先级查找图片
                    for (const imageType of priorityOrder) {
                        const foundImage = brand.images.find(img => img.image_type === imageType);
                        if (foundImage) {
                            return this.getImageURL(foundImage);
                        }
                    }
                    
                    // 如果没有匹配的类型，使用第一张图片
                    if (brand.images.length > 0) {
                        return this.getImageURL(brand.images[0]);
                    }
                    return null;
                },

                async openBrandDetail(brand) {
                    if (PerformanceConfig.performanceMonitoring.verboseLogging) {
                        console.log('打开品牌详情:', brand);
                    }
                    
                    // 使用智能缓存管理器获取品牌详情
                    const brandDetail = await window.cacheManager.getOrFetch(
                        'brand_detail',
                        async () => {
                            if (PerformanceConfig.performanceMonitoring.verboseLogging) {
                                console.log('从API获取品牌详情...');
                            }
                            try {
                                const response = await window.api.getBrandDetail(brand.name);
                                if (response && response.success && response.images) {
                                    return {
                                        brand_info: response.brand_info,
                                        images: response.images
                                    };
                                }
                            } catch (error) {
                                console.warn('API获取品牌详情失败:', error);
                            }
                            
                            // 如果API失败，使用本地数据
                            return {
                                brand_info: brand,
                                images: brand.images || []
                            };
                        },
                        brand.name
                    );
                    
                    // 设置品牌详情数据
                    this.selectedBrand = brandDetail.brand_info;
                    this.brandImages = brandDetail.images;
                    
                    // 获取点赞状态
                    const brandName = this.selectedBrand.name || this.selectedBrand.brand_name;
                    if (brandName) {
                        await this.getLikeStatus(brandName);
                    }
                    
                    // 显示模态框
                    this.showModal = true;
                    document.body.style.overflow = 'hidden';
                },

                closeModal() {
                    this.showModal = false;
                    document.body.style.overflow = 'auto';
                    setTimeout(() => {
                        this.selectedBrand = null;
                        this.brandImages = [];
                    }, 300);
                },

                getCategorizedImages() {
                    if (!this.selectedBrand || !this.selectedBrand.images) {
                        return {};
                    }
                    
                    const categories = {};
                    
                    this.selectedBrand.images.forEach(img => {
                        // 优先检查image_type字段，如果没有则从文件名中提取图片类型
                        let type = '其他';
                        
                        // 先检查 image_type 字段
                        if (img.image_type) {
                            type = img.image_type;
                        } else {
                            // 从文件名中提取图片类型
                                                if (img.filename.includes('-概念图-') || img.filename.includes('概念图')) {
                        type = '概念图';
                            } else if (img.filename.includes('-设计图-') || img.filename.includes('设计图')) {
                                type = '设计图';
                            } else if (img.filename.includes('-成衣图-') || img.filename.includes('成衣图')) {
                                type = '成衣图';
                            } else if (img.filename.includes('-布料图-') || img.filename.includes('布料图')) {
                                type = '布料图';
                            } else if (img.filename.includes('-模特图-') || img.filename.includes('模特图')) {
                                type = '模特图';
                            } else if (img.filename.includes('-买家秀图-') || img.filename.includes('买家秀')) {
                                type = '买家秀图';
                            }
                        }
                        
                        if (!categories[type]) {
                            categories[type] = [];
                        }
                        categories[type].push(img);
                    });
                    
                    // 按用户要求的优先级顺序排序：概念图 > 设计图 > 布料图 > 成衣图 > 模特图 > 买家秀图 > 其他类型
                    const orderedCategories = {};
                    const order = ['概念图', '设计图', '布料图', '成衣图', '模特图', '买家秀图', '其他'];
                    
                    order.forEach(type => {
                        if (categories[type] && categories[type].length > 0) {
                            orderedCategories[type] = categories[type];
                        }
                    });
                    
                    return orderedCategories;
                },

                groupImagesByColor(images) {
                    if (!images || images.length === 0) {
                        return {};
                    }
                    
                    const colorGroups = {};
                    
                    images.forEach(img => {
                        // 从文件名中提取颜色信息
                        let color = '默认色';
                        const filename = img.filename;
                        
                        // 匹配括号中的颜色信息
                        const colorMatch = filename.match(/\(([^)]+)\)/);
                        if (colorMatch) {
                            color = colorMatch[1];
                        }
                        
                        if (!colorGroups[color]) {
                            colorGroups[color] = [];
                        }
                        colorGroups[color].push(img);
                    });
                    
                    // 按文件名编号排序
                    Object.keys(colorGroups).forEach(color => {
                        colorGroups[color].sort((a, b) => {
                            const aNum = parseInt(a.filename.match(/-(\d+)\./)?.[1] || '0');
                            const bNum = parseInt(b.filename.match(/-(\d+)\./)?.[1] || '0');
                            return aNum - bNum;
                        });
                    });
                    
                    return colorGroups;
                },

                getDesignImages() {
                    return this.brandImages.filter(img => img.image_type === '设计图');
                },

                getFabricImages() {
                    return this.brandImages.filter(img => img.image_type === '布料图');
                },

                getImageURL(image) {
                    try {
                        // 优先使用OSS图片URL（如果存在）
                        if (image.medium_url && image.medium_url.startsWith('http')) {
                            return image.medium_url;
                        }
                        
                        // 兼容现有的URL字段
                        if (image.url && image.url.startsWith('http')) {
                            return image.url;
                        }
                        
                        // 本地图片路径处理
                        if (image.relative_path) {
                            // 使用前端静态文件路径，正确编码中文字符
                            const encodedPath = image.relative_path.split('/').map(part => encodeURIComponent(part)).join('/');
                            return `/static/images/${encodedPath}`;
                        }
                        
                        // 最后的降级处理
                        return `/static/images/${image.filename || 'placeholder.jpg'}`;
                    } catch (error) {
                        console.warn('图片URL处理失败:', error, image);
                        // 降级处理：直接使用原始路径
                        return `/static/images/${image.relative_path || image.filename || 'placeholder.jpg'}`;
                    }
                },

                shareCard() {
                    try {
                        const brandName = this.selectedBrand.name || this.selectedBrand.brand_name || '未知品牌';
                        const shareData = {
                            title: `南意秋棠 - ${brandName}`,
                            text: `查看这个漂亮的传统美学设计：${brandName}`,
                            url: window.location.href
                        };

                        if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                            navigator.share(shareData).catch(err => {
                                console.log('分享失败:', err);
                                this.fallbackShare();
                            });
                        } else {
                            this.fallbackShare();
                        }
                    } catch (error) {
                        console.error('分享错误:', error);
                        this.fallbackShare();
                    }
                },

                fallbackShare() {
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(window.location.href).then(() => {
                            alert('链接已复制到剪贴板，您可以手动分享');
                        }).catch(() => {
                            this.showShareOptions();
                        });
                    } else {
                        this.showShareOptions();
                    }
                },

                showShareOptions() {
                    const brandName = this.selectedBrand.name || this.selectedBrand.brand_name || '未知品牌';
                    const message = `南意秋棠 - ${brandName}\n${window.location.href}`;
                    
                    // 尝试打开微信分享（仅在微信浏览器中有效）
                    if (/MicroMessenger/i.test(navigator.userAgent)) {
                        alert('请点击右上角分享按钮分享到微信');
                    } else {
                        // 创建一个临时文本区域来复制文本
                        const textArea = document.createElement('textarea');
                        textArea.value = message;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            alert('分享内容已复制，您可以粘贴到微信或其他平台分享');
                        } catch (err) {
                            alert(`请手动复制以下内容分享：\n${message}`);
                        }
                        document.body.removeChild(textArea);
                    }
                },

                handleImageError(event) {
                    // 图片加载失败时的处理
                    const img = event.target;
                    console.warn('图片加载失败:', img.src);
                    
                    // 尝试重新加载一次（去掉编码）
                    if (!img.dataset.retried) {
                        img.dataset.retried = 'true';
                        const originalSrc = img.src;
                        // 尝试解码URL再重新加载
                        try {
                            const decodedSrc = decodeURIComponent(originalSrc);
                            if (decodedSrc !== originalSrc) {
                                img.src = decodedSrc;
                                return;
                            }
                        } catch (e) {
                            // 解码失败，继续原逻辑
                        }
                    }
                    
                    // 最终失败时隐藏图片并显示占位符
                    img.style.display = 'none';
                    
                    // 添加占位符
                    const placeholder = document.createElement('div');
                    placeholder.className = 'image-placeholder';
                    placeholder.innerHTML = '<i class="fas fa-image"></i><br>图片加载失败';
                    placeholder.style.cssText = `
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        width: 100%;
                        height: 200px;
                        background: #f5f5f5;
                        color: #999;
                        border-radius: 8px;
                        font-size: 14px;
                    `;
                    img.parentNode.insertBefore(placeholder, img);
                },

                openImagePreview(image) {
                    this.previewImage = image;
                    document.body.style.overflow = 'hidden';
                },

                closeImagePreview() {
                    this.previewImage = null;
                    document.body.style.overflow = 'auto';
                },

                downloadImage(image) {
                    const link = document.createElement('a');
                    link.href = this.getImageURL(image);
                    link.download = image.filename || 'image.jpg';
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },

                openCustomerService() {
                    // 智能客服功能
                    const wechatId = 'LPumpkin0217';
                    const qqNumber = '502517787';

                    // 创建客服选择弹窗
                    const modal = document.createElement('div');
                    modal.className = 'customer-service-modal';
                    modal.innerHTML = `
                        <div class="customer-service-overlay" onclick="this.parentElement.remove()">
                            <div class="customer-service-content" onclick="event.stopPropagation()">
                                <div class="customer-service-header">
                                    <h3>联系客服</h3>
                                    <button onclick="this.closest('.customer-service-modal').remove()" class="close-btn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="customer-service-options">
                                    <div class="service-option" onclick="window.copyToClipboard('${wechatId}', '微信号')">
                                        <div class="service-icon">
                                            <i class="fab fa-weixin"></i>
                                        </div>
                                        <div class="service-info">
                                            <div class="service-name">微信客服</div>
                                            <div class="service-id">${wechatId}</div>
                                        </div>
                                        <div class="copy-hint">点击复制</div>
                                    </div>
                                    <div class="service-option" onclick="window.copyToClipboard('${qqNumber}', 'QQ号')">
                                        <div class="service-icon">
                                            <i class="fab fa-qq"></i>
                                        </div>
                                        <div class="service-info">
                                            <div class="service-name">QQ客服</div>
                                            <div class="service-id">${qqNumber}</div>
                                        </div>
                                        <div class="copy-hint">点击复制</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // 添加样式
                    const style = document.createElement('style');
                    style.textContent = `
                        .customer-service-modal {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            z-index: 10000;
                        }
                        .customer-service-overlay {
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.5);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }
                        .customer-service-content {
                            background: white;
                            border-radius: 12px;
                            padding: 0;
                            max-width: 400px;
                            width: 90%;
                            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                        }
                        .customer-service-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 1rem;
                            border-bottom: 1px solid #eee;
                        }
                        .customer-service-header h3 {
                            margin: 0;
                            color: #333;
                            font-size: 1.1rem;
                        }
                        .customer-service-options {
                            padding: 1rem;
                            display: flex;
                            flex-direction: column;
                            gap: 0.8rem;
                        }
                        .service-option {
                            display: flex;
                            align-items: center;
                            gap: 0.8rem;
                            padding: 0.8rem;
                            border: 2px solid #e5e7eb;
                            border-radius: 8px;
                            background: white;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            font-size: 0.9rem;
                        }
                        @media (max-width: 768px) {
                            .customer-service-content {
                                max-width: 320px;
                                width: 85%;
                            }
                            .customer-service-header {
                                padding: 0.8rem;
                            }
                            .customer-service-header h3 {
                                font-size: 1rem;
                            }
                            .customer-service-options {
                                padding: 0.8rem;
                                gap: 0.6rem;
                            }
                            .service-option {
                                gap: 0.6rem;
                                padding: 0.6rem;
                                font-size: 0.85rem;
                            }
                            .service-icon i {
                                font-size: 1.2rem !important;
                            }
                            .service-name {
                                font-size: 0.85rem;
                            }
                            .service-id {
                                font-size: 0.8rem;
                            }
                            .copy-hint {
                                font-size: 0.7rem;
                                padding: 0.2rem 0.4rem;
                            }
                        }
                        .service-option:hover {
                            border-color: #667eea;
                            background: #f8f9ff;
                            transform: translateY(-2px);
                        }
                        .service-icon i {
                            font-size: 1.5rem;
                            color: #667eea;
                        }
                        .service-info {
                            flex: 1;
                            text-align: left;
                        }
                        .service-name {
                            font-weight: 600;
                            color: #333;
                            margin-bottom: 0.25rem;
                        }
                        .service-id {
                            color: #667eea;
                            font-family: monospace;
                            font-size: 0.9rem;
                        }
                        .copy-hint {
                            color: #999;
                            font-size: 0.8rem;
                            background: #f3f4f6;
                            padding: 0.25rem 0.5rem;
                            border-radius: 4px;
                        }
                    `;

                    document.head.appendChild(style);
                    document.body.appendChild(modal);
                    
                    // 设置全局复制函数
                    window.copyToClipboard = this.copyToClipboard;
                },

                // 复制到剪贴板功能
                copyToClipboard(text, type) {
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(text).then(() => {
                            alert(`${type}已复制到剪贴板：${text}`);
                        }).catch(() => {
                            this.fallbackCopyTextToClipboard(text, type);
                        });
                    } else {
                        this.fallbackCopyTextToClipboard(text, type);
                    }
                },

                // 降级复制方案
                fallbackCopyTextToClipboard(text, type) {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        const successful = document.execCommand('copy');
                        if (successful) {
                            alert(`${type}已复制到剪贴板：${text}`);
                        } else {
                            alert(`复制失败，请手动复制：${text}`);
                        }
                    } catch (err) {
                        alert(`复制失败，请手动复制：${text}`);
                    }
                    
                    document.body.removeChild(textArea);
                },

                // 处理logo点击
                handleLogoClick(event) {
                    // 移动端直接跳转，不阻止默认行为
                    if (window.innerWidth <= 768) {
                        // 移动端：直接跳转
                        window.open('https://shop357296168.taobao.com/?spm=a21n57.shop_search.0.0.1ad93904ohsQt4', '_blank');
                        event.preventDefault(); // 阻止默认的a标签行为，使用我们的跳转
                    }
                    // 桌面端：使用默认的a标签行为
                },

                // 通过标签筛选品牌
                filterByTag(filterType, filterValue) {
                    console.log(`点击筛选: ${filterType} = ${filterValue}`);
                    
                    // 关闭模态框（如果是从详情页点击的）
                    if (this.showModal) {
                        this.closeModal();
                    }
                    
                    // 清除搜索框内容
                    this.searchQuery = '';
                    
                    // 支持标签的toggle功能
                    if (filterType === 'year') {
                        // 年份是单选，点击相同值则取消
                        if (this.activeFilters[filterType] === filterValue) {
                            this.activeFilters[filterType] = null;
                        } else {
                            this.activeFilters[filterType] = filterValue;
                        }
                    } else {
                        // 多选类型支持组合筛选
                        if (!this.activeFilters[filterType]) {
                            this.activeFilters[filterType] = [];
                        }
                        
                        const index = this.activeFilters[filterType].indexOf(filterValue);
                        if (index > -1) {
                            // 已存在，移除
                            this.activeFilters[filterType].splice(index, 1);
                            if (this.activeFilters[filterType].length === 0) {
                                this.activeFilters[filterType] = null;
                            }
                        } else {
                            // 不存在，添加
                            this.activeFilters[filterType].push(filterValue);
                        }
                    }
                    
                    // 应用筛选
                    this.filterBrands();
                    
                    // 滚动到筛选区域
                    const filterSection = document.querySelector('.filter-section');
                    if (filterSection) {
                        filterSection.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }
                },

                // 清除单个筛选条件
                clearFilter(filterType) {
                    console.log(`清除筛选: ${filterType}`);
                    
                    // 清除指定的筛选条件
                    this.activeFilters[filterType] = null;
                    
                    // 应用筛选
                    this.filterBrands();
                },

                // 检查是否有任何活跃的筛选条件
                hasAnyActiveFilters() {
                    return Object.values(this.activeFilters).some(filter => 
                        filter !== null && 
                        filter !== undefined && 
                        (Array.isArray(filter) ? filter.length > 0 : true)
                    );
                },

                // 简单的Markdown格式化
                formatMarkdown(text) {
                    if (!text) return '';
                    
                    return text
                        // 粗体 **text** 或 __text__
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/__(.*?)__/g, '<strong>$1</strong>')
                        // 斜体 *text* 或 _text_
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/_(.*?)_/g, '<em>$1</em>')
                        // 换行
                        .replace(/\n/g, '<br>')
                        // 段落分隔
                        .replace(/\n\n/g, '</p><p>')
                        // 包装在段落中
                        .replace(/^(.+)$/, '<p>$1</p>');
                },

                generateShareCard() {
                    console.log('生成布料卡片', this.selectedBrand);
                    
                    if (!this.selectedBrand) {
                        this.showToast('请先选择一个品牌');
                        return;
                    }
                    
                    const brandName = this.selectedBrand.name || this.selectedBrand.brand_name;
                    
                    // 显示生成中提示
                    this.showToast('正在生成卡片...');
                    
                    // 调用后端API生成卡片数据
                    const apiUrl = window.api ? 
                        `${window.api.baseURL}/share/card/${encodeURIComponent(brandName)}` : 
                        `http://localhost:5001/api/share/card/${encodeURIComponent(brandName)}`;
                    
                    fetch(apiUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                // 跳转到卡片页面
                                const cardUrl = `card.html?brand=${encodeURIComponent(brandName)}`;
                                window.open(cardUrl, '_blank');
                                this.showToast('卡片生成成功！');
                            } else {
                                this.showToast('生成卡片失败: ' + (data.error || '未知错误'));
                            }
                        })
                        .catch(error => {
                            console.error('生成卡片失败:', error);
                            // 提供更详细的错误信息
                            if (error.message.includes('Failed to fetch')) {
                                this.showToast('网络连接失败，请检查网络后重试');
                            } else if (error.message.includes('HTTP')) {
                                this.showToast('服务器错误: ' + error.message);
                            } else {
                                this.showToast('生成卡片失败，请稍后重试');
                            }
                        });
                },

                showToast(message, duration = 2000) {
                    // 创建提示框
                    const toast = document.createElement('div');
                    toast.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.8);
                        color: white;
                        padding: 15px 25px;
                        border-radius: 25px;
                        font-size: 0.9rem;
                        z-index: 10000;
                        animation: fadeInOut ${duration}ms ease-in-out;
                        max-width: 80%;
                        text-align: center;
                    `;
                    
                    // 添加动画样式
                    const style = document.createElement('style');
                    style.textContent = `
                        @keyframes fadeInOut {
                            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                            15% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                            85% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                        }
                    `;
                    document.head.appendChild(style);
                    
                    toast.textContent = message;
                    document.body.appendChild(toast);
                    
                    // 自动移除
                    setTimeout(() => {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                        if (document.head.contains(style)) {
                            document.head.removeChild(style);
                        }
                    }, duration);
                },

                // 首页点赞功能
                async toggleHomeLike(brand) {
                    if (!brand) return;
                    
                    try {
                        const brandName = brand.name || brand.brand_name;
                        const apiUrl = window.api ? 
                            `${window.api.baseURL}/like/card/${encodeURIComponent(brandName)}` : 
                            `/api/like/card/${encodeURIComponent(brandName)}`;
                        
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // 更新品牌的点赞状态和数量
                            brand.user_liked = data.liked;
                            brand.like_count = data.like_count;
                            
                            // 更新brandData中的数据
                            if (this.brandData[brandName]) {
                                this.brandData[brandName].user_liked = data.liked;
                                this.brandData[brandName].like_count = data.like_count;
                            }
                            
                            // 显示成功提示
                            this.showToast(data.message || (data.liked ? '点赞成功！' : '取消点赞成功！'));
                        } else {
                            this.showToast(data.message || '操作失败，请稍后重试');
                        }
                    } catch (error) {
                        console.error('首页点赞操作失败:', error);
                        this.showToast('网络错误，请稍后重试');
                    }
                },
                
                async toggleLike() {
                    if (this.brandLikeStatus.loading || !this.selectedBrand) {
                        return;
                    }
                    
                    this.brandLikeStatus.loading = true;
                    
                    try {
                        const brandName = this.selectedBrand.name || this.selectedBrand.brand_name;
                        const apiUrl = window.api ? 
                            `${window.api.baseURL}/like/card/${encodeURIComponent(brandName)}` : 
                            `/api/like/card/${encodeURIComponent(brandName)}`;
                        
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            this.brandLikeStatus.liked = data.liked;
                            this.brandLikeStatus.count = data.like_count;
                            
                            // 更新品牌列表中的点赞数
                            if (this.brandData[brandName]) {
                                this.brandData[brandName].like_count = data.like_count;
                            }
                            
                            // 更新当前选中品牌的点赞数
                            this.selectedBrand.like_count = data.like_count;
                            
                            // 显示成功提示
                            this.showToast(data.message || (data.liked ? '点赞成功！' : '取消点赞成功！'));
                        } else {
                            this.showToast(data.message || '操作失败，请稍后重试');
                        }
                    } catch (error) {
                        console.error('点赞操作失败:', error);
                        this.showToast('网络错误，请稍后重试');
                    } finally {
                        this.brandLikeStatus.loading = false;
                    }
                },

                async getLikeStatus(brandName) {
                    try {
                        const apiUrl = window.api ? 
                            `${window.api.baseURL}/like/card/${encodeURIComponent(brandName)}` : 
                            `/api/like/card/${encodeURIComponent(brandName)}`;
                        
                        const response = await fetch(apiUrl, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                this.brandLikeStatus.liked = data.liked;
                                this.brandLikeStatus.count = data.like_count;
                            }
                        }
                    } catch (error) {
                        console.error('获取点赞状态失败:', error);
                        // 使用本地数据作为默认值
                        this.brandLikeStatus.liked = false;
                        this.brandLikeStatus.count = this.selectedBrand?.like_count || 0;
                    }
                }
            }
        });

        // 全局错误处理
        app.config.errorHandler = (err, instance, info) => {
            console.error('Vue全局错误:', err);
            console.error('错误信息:', info);
            console.error('组件实例:', instance);
        };

        // 挂载应用
        try {
            app.mount('#app');
            console.log('Vue应用挂载成功');
            
            // 初始化图片懒加载
            setTimeout(() => {
                initImageLazyLoading();
            }, 1000);
            
        } catch (error) {
            console.error('Vue应用挂载失败:', error);
            document.getElementById('app').innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <h3>应用加载失败</h3>
                    <p>请刷新页面重试</p>
                    <button onclick="location.reload()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        刷新页面
                    </button>
                </div>
            `;
        }

        // 图片懒加载功能
        function initImageLazyLoading() {
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            const src = img.dataset.src;
                            if (src) {
                                img.src = src;
                                img.removeAttribute('data-src');
                                observer.unobserve(img);
                            }
                        }
                    });
                }, {
                    rootMargin: '50px 0px', // 提前50px开始加载
                    threshold: 0.1
                });

                // 观察所有带有data-src属性的图片
                document.querySelectorAll('img[data-src]').forEach(img => {
                    imageObserver.observe(img);
                });

                // 监听DOM变化，自动处理新添加的图片
                const mutationObserver = new MutationObserver(mutations => {
                    mutations.forEach(mutation => {
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === 1) { // Element node
                                const lazyImages = node.querySelectorAll ? node.querySelectorAll('img[data-src]') : [];
                                lazyImages.forEach(img => imageObserver.observe(img));
                                
                                if (node.tagName === 'IMG' && node.dataset.src) {
                                    imageObserver.observe(node);
                                }
                            }
                        });
                    });
                });

                mutationObserver.observe(document.body, {
                    childList: true,
                    subtree: true
                });
            }
        }

        // API配置 - 智能检测访问方式
        const currentHost = window.location.hostname;
        let API_BASE_URL;
        
        if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
            // 本地开发环境
            API_BASE_URL = 'http://localhost:5001';
        } else if (currentHost.includes('nanyiqiutang.cn') || currentHost.includes('chenxiaoshivivid.com.cn')) {
            // 域名访问，使用相对路径让nginx代理处理
            API_BASE_URL = '';
        } else {
            // IP访问，直接连接后端端口
            API_BASE_URL = 'http://121.36.205.70:5001';
        }
            
        console.log('API Base URL:', API_BASE_URL);
        
        // 确保API调用使用正确的地址
        function getApiUrl(endpoint) {
            return `${API_BASE_URL}${endpoint}`;
        }
    </script>
    
    <!-- 微信分享优化脚本 -->
    <script>
        // 检测是否在微信内置浏览器中
        function isWeChatBrowser() {
            return /micromessenger/i.test(navigator.userAgent);
        }
        
        // 微信分享配置
        function setupWeChatShare() {
            // 设置分享内容
            const shareConfig = {
                title: '南意秋棠 - 传统美学设计',
                desc: '传承经典 美美与共 - 古典美学设计，望君着美于裳',
                link: window.location.href.split('?')[0], // 移除查询参数
                                        imgUrl: window.location.origin + '/static/images/牡丹亭/牡丹亭-概念图-01.jpg'
            };
            
            // 确保页面title正确
            document.title = shareConfig.title;
            
            // 动态更新meta标签
            updateMetaTag('og:title', shareConfig.title);
            updateMetaTag('og:description', shareConfig.desc);
            updateMetaTag('og:url', shareConfig.link);
            updateMetaTag('og:image', shareConfig.imgUrl);
            updateMetaTag('description', shareConfig.desc);
            
            // 如果在微信浏览器中且有微信JS-SDK
            if (isWeChatBrowser() && typeof wx !== 'undefined') {
                // 配置微信JS-SDK
                wx.config({
                    debug: false, // 开启调试模式
                    appId: '', // 必填，公众号的唯一标识
                    timestamp: Math.floor(Date.now() / 1000), // 必填，生成签名的时间戳
                    nonceStr: 'nanyiqiutang' + Math.random().toString(36).substr(2, 15), // 必填，生成签名的随机串
                    signature: '', // 必填，签名
                    jsApiList: [
                        'updateAppMessageShareData',
                        'updateTimelineShareData'
                    ] // 必填，需要使用的JS接口列表
                });
                
                // 即使没有签名，也尝试设置分享内容（有些情况下仍然有效）
                wx.ready(function() {
                    console.log('微信JS-SDK已准备就绪');
                    
                    // 分享给朋友
                    wx.updateAppMessageShareData({
                        title: shareConfig.title,
                        desc: shareConfig.desc,
                        link: shareConfig.link,
                        imgUrl: shareConfig.imgUrl,
                        success: function () {
                            console.log('微信分享给朋友配置成功');
                        },
                        fail: function(err) {
                            console.log('微信分享给朋友配置失败:', err);
                        }
                    });
                    
                    // 分享到朋友圈
                    wx.updateTimelineShareData({
                        title: shareConfig.title,
                        link: shareConfig.link,
                        imgUrl: shareConfig.imgUrl,
                        success: function () {
                            console.log('微信朋友圈分享配置成功');
                        },
                        fail: function(err) {
                            console.log('微信朋友圈分享配置失败:', err);
                        }
                    });
                });
                
                wx.error(function(res) {
                    console.log('微信JS-SDK配置失败:', res);
                    // 如果JS-SDK配置失败，使用传统方法
                    setupTraditionalShare(shareConfig);
                });
            } else {
                // 非微信环境或没有JS-SDK，使用传统分享方法
                setupTraditionalShare(shareConfig);
            }
        }
        
        // 传统分享方法（通过meta标签）
        function setupTraditionalShare(shareConfig) {
            console.log('使用传统分享方法');
            
            // 添加额外的meta标签以提高兼容性
            addMetaTag('og:title', shareConfig.title);
            addMetaTag('og:description', shareConfig.desc);
            addMetaTag('og:image', shareConfig.imgUrl);
            addMetaTag('og:url', shareConfig.link);
            addMetaTag('description', shareConfig.desc);
            
            // 微信专用标签
            addMetaTag('weixin:timeline_title', shareConfig.title);
            addMetaTag('weixin:appmsg_title', shareConfig.title);
            addMetaTag('weixin:appmsg_desc', shareConfig.desc);
            addMetaTag('weixin:timeline_desc', shareConfig.desc);
            addMetaTag('weixin:img_url', shareConfig.imgUrl);
        }
        
        // 更新已存在的meta标签
        function updateMetaTag(property, content) {
            let meta = document.querySelector(`meta[property="${property}"], meta[name="${property}"]`);
            if (meta) {
                meta.setAttribute('content', content);
            }
        }
        
        // 添加新的meta标签
        function addMetaTag(name, content) {
            // 先尝试更新已存在的
            updateMetaTag(name, content);
            
            // 如果不存在，则创建新的
            if (!document.querySelector(`meta[property="${name}"], meta[name="${name}"]`)) {
                const meta = document.createElement('meta');
                if (name.startsWith('og:') || name.startsWith('twitter:')) {
                    meta.setAttribute('property', name);
                } else {
                    meta.setAttribute('name', name);
                }
                meta.setAttribute('content', content);
                document.head.appendChild(meta);
            }
        }
        
        // 页面加载完成后设置分享
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，设置微信分享');
            console.log('是否在微信浏览器:', isWeChatBrowser());
            setupWeChatShare();
        });
        
        // Vue应用加载后再次设置
        if (window.Vue) {
            setTimeout(function() {
                console.log('Vue应用加载完成，重新设置微信分享');
                setupWeChatShare();
            }, 2000);
        }
        
        // 页面可见性变化时重新设置（解决微信缓存问题）
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                setTimeout(function() {
                    console.log('页面重新可见，重新设置微信分享');
                    setupWeChatShare();
                }, 500);
            }
        });
        
        // 监听页面URL变化（SPA应用）
        let currentUrl = window.location.href;
        setInterval(function() {
            if (window.location.href !== currentUrl) {
                currentUrl = window.location.href;
                console.log('URL变化，重新设置微信分享');
                setTimeout(setupWeChatShare, 500);
            }
        }, 1000);
    </script>

    <!-- 网页底部版权信息 -->
    <footer class="simple-footer">
        <div class="container">
            <div class="footer-copyright">
                <p>备案号：浙ICP备2024081979号 | 版权所有，nanyiqiutang.cn南意秋棠</p>
            </div>
        </div>
    </footer>

</body>
</html> 