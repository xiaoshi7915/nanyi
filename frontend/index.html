<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>南意秋棠 - 汉文化布料设计</title>
    
    <!-- Vue.js 3 -->
    <script src="static/lib/vue.global.js"></script>
    
    <!-- 引入图标库 -->
    <link rel="stylesheet" href="static/lib/all.min.css">
    
    <!-- 引入样式文件 -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="static/css/responsive.css">
    
    <!-- 引入优化的缓存管理器 -->
    <script>
        /**
         * 优化的前端缓存管理器
         * 针对稳定的图片资源进行长期缓存，提升性能
         */
        class OptimizedCacheManager {
            constructor() {
                this.cachePrefix = 'nanyi_cache_';
                this.versionKey = 'nanyi_version';
                this.defaultTTL = 60 * 60 * 1000; // 1小时默认缓存时间
                
                // 优化的缓存策略 - 针对稳定资源延长缓存时间
                this.cacheStrategies = {
                    'brands': {
                        ttl: 24 * 60 * 60 * 1000,     // 24小时 - 品牌数据稳定
                        checkUpdate: false,           // 不主动检查更新，减少请求
                        priority: 'high'              // 高优先级缓存
                    },
                    'images': {
                        ttl: 24 * 60 * 60 * 1000,    // 24小时 - 图片列表很稳定
                        checkUpdate: false,           // 不主动检查更新
                        priority: 'high'
                    },
                    'filters': {
                        ttl: 12 * 60 * 60 * 1000,    // 12小时 - 筛选选项很少变化
                        checkUpdate: false,
                        priority: 'medium'
                    },
                    'brand_detail': {
                        ttl: 24 * 60 * 60 * 1000,     // 6小时 - 品牌详情稳定
                        checkUpdate: false,           // 不主动检查更新
                        priority: 'high'
                    }
                };
                
                this.init();
            }
            
            init() {
                // 检查应用版本，如果版本变化则清空所有缓存
                this.checkAppVersion();
                
                // 定期清理过期缓存（降低频率）
                setInterval(() => {
                    this.cleanExpiredCache();
                }, 5 * 60000); // 每5分钟清理一次
            }
            
            /**
             * 检查应用版本（降低检查频率）
             */
            checkAppVersion() {
                const currentVersion = this.getAppVersion();
                const cachedVersion = localStorage.getItem(this.versionKey);
                
                if (cachedVersion && cachedVersion !== currentVersion) {
                    console.log('检测到应用版本更新，清空缓存');
                    this.clearAllCache();
                }
                
                localStorage.setItem(this.versionKey, currentVersion);
            }
            
            /**
             * 获取应用版本（基于当前时间戳的天数，每天检查一次更新）
             */
            getAppVersion() {
                return Math.floor(Date.now() / (24 * 60 * 60 * 1000)).toString();
            }
            
            /**
             * 生成缓存键
             */
            generateKey(type, identifier = '') {
                return `${this.cachePrefix}${type}_${identifier}`;
            }
            
            /**
             * 设置缓存
             */
            set(type, data, identifier = '') {
                const strategy = this.cacheStrategies[type] || { ttl: this.defaultTTL };
                const key = this.generateKey(type, identifier);
                const now = Date.now();
                
                const cacheData = {
                    data: data,
                    timestamp: now,
                    expires: now + strategy.ttl,
                    etag: this.generateETag(data),
                    type: type,
                    priority: strategy.priority || 'medium'
                };
                
                try {
                    localStorage.setItem(key, JSON.stringify(cacheData));
                    console.log(`✅ 缓存已设置: ${type} (${identifier}), TTL: ${Math.round(strategy.ttl / 60000)}分钟`);
                } catch (e) {
                    console.warn('缓存设置失败:', e);
                    // 如果存储空间不足，清理低优先级缓存
                    this.cleanLowPriorityCache();
                    try {
                        localStorage.setItem(key, JSON.stringify(cacheData));
                    } catch (e2) {
                        console.error('缓存设置最终失败:', e2);
                    }
                }
            }
            
            /**
             * 获取缓存
             */
            get(type, identifier = '') {
                const key = this.generateKey(type, identifier);
                
                try {
                    const cached = localStorage.getItem(key);
                    if (!cached) {
                        return null;
                    }
                    
                    const cacheData = JSON.parse(cached);
                    const now = Date.now();
                    
                    // 检查是否过期
                    if (now > cacheData.expires) {
                        console.log(`⏰ 缓存已过期: ${type} (${identifier})`);
                        localStorage.removeItem(key);
                        return null;
                    }
                    
                    const remainingMinutes = Math.round((cacheData.expires - now) / 60000);
                    console.log(`✅ 缓存命中: ${type} (${identifier}), 剩余: ${remainingMinutes}分钟`);
                    return cacheData.data;
                } catch (e) {
                    console.warn('缓存读取失败:', e);
                    localStorage.removeItem(key);
                    return null;
                }
            }
            
            /**
             * 智能获取数据（缓存优先，不主动更新）
             */
            async getOrFetch(type, fetchFunction, identifier = '') {
                // 先尝试从缓存获取
                const cached = this.get(type, identifier);
                
                if (cached) {
                    // 对于稳定资源，直接返回缓存，不进行后台更新
                    return cached;
                }
                
                // 缓存未命中，直接获取数据
                try {
                    const data = await fetchFunction();
                    if (data) {
                        this.set(type, data, identifier);
                    }
                    return data;
                } catch (e) {
                    console.error('数据获取失败:', e);
                    throw e;
                }
            }
            
            /**
             * 生成数据的ETag
             */
            generateETag(data) {
                const str = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // 转换为32位整数
                }
                return hash.toString(36);
            }
            
            /**
             * 清理过期缓存
             */
            cleanExpiredCache() {
                const now = Date.now();
                const keysToRemove = [];
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(this.cachePrefix)) {
                        try {
                            const cached = localStorage.getItem(key);
                            const cacheData = JSON.parse(cached);
                            
                            if (now > cacheData.expires) {
                                keysToRemove.push(key);
                            }
                        } catch (e) {
                            keysToRemove.push(key); // 损坏的缓存也删除
                        }
                    }
                }
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                });
                
                if (keysToRemove.length > 0) {
                    console.log(`🧹 清理了 ${keysToRemove.length} 个过期缓存`);
                }
            }
            
            /**
             * 清理低优先级缓存
             */
            cleanLowPriorityCache() {
                const cacheItems = [];
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(this.cachePrefix)) {
                        try {
                            const cached = localStorage.getItem(key);
                            const cacheData = JSON.parse(cached);
                            cacheItems.push({
                                key: key,
                                timestamp: cacheData.timestamp,
                                priority: cacheData.priority || 'medium'
                            });
                        } catch (e) {
                            localStorage.removeItem(key);
                        }
                    }
                }
                
                // 按优先级和时间排序，删除低优先级的旧缓存
                cacheItems.sort((a, b) => {
                    const priorityOrder = { 'low': 0, 'medium': 1, 'high': 2 };
                    const aPriority = priorityOrder[a.priority] || 1;
                    const bPriority = priorityOrder[b.priority] || 1;
                    
                    if (aPriority !== bPriority) {
                        return aPriority - bPriority; // 低优先级在前
                    }
                    return a.timestamp - b.timestamp; // 旧的在前
                });
                
                const toDelete = cacheItems.slice(0, Math.floor(cacheItems.length / 3));
                
                toDelete.forEach(item => {
                    localStorage.removeItem(item.key);
                });
                
                console.log(`🧹 清理了 ${toDelete.length} 个低优先级缓存`);
            }
            
            /**
             * 清空所有缓存
             */
            clearAllCache() {
                const keysToRemove = [];
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(this.cachePrefix)) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                });
                
                console.log(`🧹 清空了所有缓存 (${keysToRemove.length} 项)`);
            }
        }

        // 创建全局优化缓存管理器实例
        window.cacheManager = new OptimizedCacheManager();
    </script>
    
    <!-- 引入API客户端 -->
    <script src="js/api.js"></script>
    <!-- <script src="js/components.js"></script> -->
    <!-- <script src="static/js/main.js"></script> -->
</head>
<body>
    <div id="app">
        <!-- 头部 -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <!-- 可点击的logo，跳转到淘宝店铺 -->
                    <a href="https://shop357296168.taobao.com/?spm=a21n57.shop_search.0.0.1ad93904ohsQt4" 
                       target="_blank" 
                       class="logo-link"
                       @click="handleLogoClick">
                        <div class="logo">
                            <i class="fas fa-leaf"></i>
                            <span>南意秋棠</span>
                        </div>
                    </a>
                    <!-- 右侧图标 -->
                    <div class="header-actions">
                        <a href="https://weidian.com/?userid=1330457134&distributorid=142259736&share_relation=eae4bd30b7458ac1_142259736_1&wfr=h5direct_wxh5" 
                           target="_blank" 
                           class="header-icon" 
                           title="微店">
                            <i class="fas fa-store"></i>
                        </a>
                        <button @click="openCustomerService" class="header-icon" title="智能客服">
                            <i class="fas fa-comments"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- 英雄横幅区 -->
        <section class="hero-banner">
            <div class="container">
                <div class="hero-content">
                    <h1 class="hero-title">传承经典 创新未来</h1>
                    <p class="hero-subtitle">汉文化布料设计的艺术之美</p>
                </div>
            </div>
        </section>

        <!-- 搜索和筛选区 -->
        <section class="filter-section">
            <div class="container">
                <!-- 搜索栏 -->
                <div class="search-box">
                    <div class="search-input-container">
                        <i class="fas fa-search search-icon"></i>
                        <input 
                            v-model="searchQuery" 
                            type="text" 
                            placeholder="搜索品牌名称、布料材质、主题系列、年份..."
                            class="search-input"
                            @input="filterBrands"
                        >
                    </div>
                    <button @click="performSearch" class="search-btn">
                        搜索
                    </button>
                </div>

                <!-- 移动端年份横排筛选 -->
                <div class="mobile-only mobile-year-filter">
                    <div class="year-tags-horizontal">
                        <button 
                            @click="clearAllFilters"
                            :class="['year-tag', { active: !hasAnyActiveFilters() }]"
                        >
                            全部
                        </button>
                        <button 
                            v-for="year in filterOptions.years" 
                            :key="'mobile-year-' + year"
                            @click="toggleFilter('year', year)"
                            :class="['year-tag', { active: activeFilters.year === year }]"
                        >
                            {{ year }}
                        </button>
                    </div>
                </div>
                
                <!-- 桌面端筛选标签 -->
                <div class="filter-sections desktop-only">
                    <!-- 按年份 -->
                    <div class="filter-group">
                        <div class="filter-title">按年份</div>
                        <div class="filter-tags-container">
                            <button 
                                @click="clearFilter('year')"
                                :class="['filter-tag', { active: !activeFilters.year }]"
                            >
                                全部({{ Object.values(brandData).length }})
                            </button>
                            <button 
                                v-for="year in filterOptions.years" 
                                :key="'year-' + year"
                                @click="toggleFilter('year', year)"
                                :class="['filter-tag', { active: activeFilters.year === year }]"
                            >
                                {{ year }}({{ brandCounts.years[year] || 0 }})
                            </button>
                        </div>
                    </div>

                    <!-- 按主题系列 - 仅电脑端显示 -->
                    <div class="filter-group desktop-only">
                        <div class="filter-title">按主题系列</div>
                        <div class="filter-tags-container">
                            <button 
                                @click="clearFilter('theme_series')"
                                :class="['filter-tag', { active: !activeFilters.theme_series }]"
                            >
                                全部({{ Object.values(brandData).length }})
                            </button>
                            <button 
                                v-for="series in filterOptions.theme_series" 
                                :key="'series-' + series"
                                @click="toggleFilter('theme_series', series)"
                                :class="['filter-tag', { 
                                    active: (Array.isArray(activeFilters.theme_series) && activeFilters.theme_series.includes(series)) || 
                                           activeFilters.theme_series === series 
                                }]"
                            >
                                {{ series }}({{ brandCounts.theme_series[series] || 0 }})
                            </button>
                        </div>
                    </div>

                    <!-- 按材质 - 仅电脑端显示 -->
                    <div class="filter-group desktop-only">
                        <div class="filter-title">按材质</div>
                        <div class="filter-tags-container">
                            <button 
                                @click="clearFilter('materials')"
                                :class="['filter-tag', { active: !activeFilters.materials }]"
                            >
                                全部({{ Object.values(brandData).length }})
                            </button>
                            <button 
                                v-for="material in filterOptions.materials" 
                                :key="'material-' + material"
                                @click="toggleFilter('materials', material)"
                                :class="['filter-tag', { 
                                    active: (Array.isArray(activeFilters.materials) && activeFilters.materials.includes(material)) || 
                                           activeFilters.materials === material 
                                }]"
                            >
                                {{ material }}({{ brandCounts.materials[material] || 0 }})
                            </button>
                        </div>
                    </div>

                    <!-- 按印制尺寸 - 仅电脑端显示 -->
                    <div class="filter-group desktop-only">
                        <div class="filter-title">按印制尺寸</div>
                        <div class="filter-tags-container">
                            <button 
                                @click="clearFilter('print_sizes')"
                                :class="['filter-tag', { active: !activeFilters.print_sizes }]"
                            >
                                全部({{ Object.values(brandData).length }})
                            </button>
                            <button 
                                v-for="size in filterOptions.print_sizes" 
                                :key="'size-' + size"
                                @click="toggleFilter('print_sizes', size)"
                                :class="['filter-tag', { 
                                    active: (Array.isArray(activeFilters.print_sizes) && activeFilters.print_sizes.includes(size)) || 
                                           activeFilters.print_sizes === size 
                                }]"
                            >
                                {{ size }}({{ brandCounts.print_sizes[size] || 0 }})
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 主要内容 -->
        <main class="main-content">
            <div class="container">
                <!-- 加载状态 -->
                <div v-if="loading" class="loading">
                    <div class="spinner"></div>
                    <p>加载中...</p>
                </div>

                <!-- 错误状态 -->
                <div v-else-if="error" class="error-state">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3>加载失败</h3>
                    <p>{{ error }}</p>
                    <button @click="loadData" class="retry-btn">重试</button>
                </div>

                <!-- 品牌网格 -->
                <div v-else-if="filteredBrands.length > 0" class="brands-grid">
                    <div 
                        v-for="brand in filteredBrands" 
                        :key="brand.name"
                        class="brand-card"
                        @click="openBrandDetail(brand)"
                    >
                        <div class="brand-image-container">
                            <img 
                                :src="getBrandCoverImage(brand)" 
                                :alt="brand.name"
                                class="brand-image"
                                loading="lazy"
                                @error="handleImageError"
                            >
                        </div>
                        <div class="brand-info">
                            <h3 class="brand-name">{{ brand.name }}</h3>
                            <div class="brand-meta">
                                <span v-if="brand.year && brand.year !== 'N/A' && brand.year !== ''" 
                                      class="meta-tag" 
                                      @click.stop="filterByTag('year', brand.year)">{{ brand.year }}年</span>
                                <span v-if="brand.theme_series && brand.theme_series !== 'N/A' && brand.theme_series !== ''" 
                                      class="meta-tag" 
                                      @click.stop="filterByTag('theme_series', brand.theme_series)">{{ brand.theme_series }}</span>
                                <span v-if="brand.material && brand.material !== 'N/A' && brand.material !== ''" 
                                      class="meta-tag" 
                                      @click.stop="filterByTag('materials', brand.material)">{{ brand.material }}</span>
                                <span v-if="brand.print_size && brand.print_size !== 'N/A' && brand.print_size !== ''" 
                                      class="meta-tag" 
                                      @click.stop="filterByTag('print_sizes', brand.print_size)">{{ brand.print_size }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 空状态 -->
                <div v-else class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3>没有找到匹配的品牌</h3>
                    <p>尝试调整搜索条件或筛选选项</p>
                </div>
            </div>
        </main>

        <!-- 品牌详情模态框 -->
        <div v-if="selectedBrand && showModal" :class="['modal-overlay', { active: showModal }]" @click="closeModal">
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h2 class="modal-title">{{ selectedBrand.name || selectedBrand.brand_name }}</h2>
                    <button @click="closeModal" class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- 基本信息 -->
                    <div class="detail-section">
                        <h3 class="section-title">基本信息</h3>
                        <div class="detail-tags">
                            <span v-if="selectedBrand.year && selectedBrand.year !== 'N/A' && selectedBrand.year !== ''" 
                                  class="detail-tag" 
                                  @click="filterByTag('year', selectedBrand.year)">{{ selectedBrand.year }}年</span>
                            <span v-if="selectedBrand.theme_series && selectedBrand.theme_series !== 'N/A' && selectedBrand.theme_series !== ''" 
                                  class="detail-tag" 
                                  @click="filterByTag('theme_series', selectedBrand.theme_series)">{{ selectedBrand.theme_series }}</span>
                            <span v-if="selectedBrand.material && selectedBrand.material !== 'N/A' && selectedBrand.material !== ''" 
                                  class="detail-tag" 
                                  @click="filterByTag('materials', selectedBrand.material)">{{ selectedBrand.material }}</span>
                            <span v-if="selectedBrand.print_size && selectedBrand.print_size !== 'N/A' && selectedBrand.print_size !== ''" 
                                  class="detail-tag" 
                                  @click="filterByTag('print_sizes', selectedBrand.print_size)">{{ selectedBrand.print_size }}</span>
                        </div>
                    </div>

                    <!-- 设计灵感 -->
                    <div v-if="selectedBrand.inspiration_origin" class="detail-section">
                        <h3 class="section-title">设计灵感</h3>
                        <div class="inspiration-text" v-html="formatMarkdown(selectedBrand.inspiration_origin)"></div>
                    </div>

                    <!-- 按类型分类的图片展示 -->
                    <div v-for="(images, type) in getCategorizedImages()" :key="type" class="detail-section">
                        <h3 class="section-title">{{ type }}</h3>
                        
                        <!-- 按颜色分组显示 -->
                        <div v-for="(colorImages, color) in groupImagesByColor(images)" :key="color" class="color-group">
                            <h4 v-if="Object.keys(groupImagesByColor(images)).length > 1" class="color-title">{{ color }}</h4>
                            <div class="image-gallery">
                                <div 
                                    v-for="image in colorImages" 
                                    :key="image.filename"
                                    class="gallery-item"
                                    @click="openImagePreview(image)"
                                >
                                    <img 
                                        :src="getImageURL(image)" 
                                        :alt="image.filename"
                                        class="gallery-image"
                                        @error="handleImageError"
                                    >
                                    <div class="image-actions">
                                        <button @click.stop="openImagePreview(image)" class="action-btn zoom-btn">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图片预览模态框 -->
        <div v-if="previewImage" class="image-preview-overlay" @click="closeImagePreview">
            <div class="image-preview-content" @click.stop>
                <button @click="closeImagePreview" class="preview-close-btn">
                    <i class="fas fa-times"></i>
                </button>
                <img 
                    :src="getImageURL(previewImage)" 
                    :alt="previewImage.filename"
                    class="preview-image"
                    @error="handleImageError"
                >
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        const app = createApp({
            data() {
                return {
                    loading: true,
                    error: null,
                    searchQuery: '',
    
                    activeFilters: {
                        year: null,
                        material: null,
                        theme_series: null,
                        print_size: null
                    },
                    filterOptions: {
                        years: [],
                        materials: [],
                        theme_series: [],
                        print_sizes: []
                    },
                    brandCounts: {},
                    currentFilterCounts: {}, // 当前筛选状态下的数量统计
                    allImages: [],
                    brandData: {},
                    filteredBrands: [],
                    selectedBrand: null,
                    brandImages: [],
                    showModal: false,
                    previewImage: null,
                    
                    // 确保初始状态正确
                    dataLoaded: false
                };
            },
            
            async mounted() {
                try {
                    console.log('Vue应用已挂载，开始加载数据...');
                    console.log('当前URL:', window.location.href);
                    console.log('API Base URL:', window.api ? window.api.baseURL : 'API未初始化');
                    
                    // 检查API是否可用
                    if (!window.api) {
                        console.error('API实例未找到！');
                        this.error = 'API服务未启动，请稍后重试';
                        this.loading = false;
                        return;
                    }
                    
                    await this.loadData();
                    
                    // 监听缓存更新事件
                    window.addEventListener('cacheDataUpdate', (event) => {
                        const { type, data } = event.detail;
                        if (type === 'brands') {
                            console.log('检测到品牌数据更新，刷新界面');
                            this.allImages = data.images || [];
                            this.brandData = {};
                            if (data.brands) {
                                data.brands.forEach(brand => {
                                    this.brandData[brand.name] = brand;
                                });
                                this.filteredBrands = data.brands;
                                this.generateFilterOptions();
                                this.filterBrands(); // 重新应用筛选
                            }
                        }
                    });
                } catch (error) {
                    console.error('Vue应用挂载失败:', error);
                    this.error = '应用初始化失败，请刷新页面重试';
                    this.loading = false;
                }
            },

            computed: {
                // 已移除hasActiveFilters计算属性，因为不再需要清除筛选功能
            },

            watch: {
                searchQuery() {
                    this.filterBrands();
                }
            },

            methods: {
                async loadData() {
                    this.loading = true;
                    this.error = null;
                    
                    try {
                        console.log('开始加载数据...');
                        
                        // 使用智能缓存管理器
                        const cachedData = await window.cacheManager.getOrFetch(
                            'brands',
                            async () => {
                                console.log('从API获取数据...');
                                // 添加重试机制
                                for (let retry = 0; retry < 3; retry++) {
                                    try {
                                        const response = await window.api.getImages();
                                        if (response && response.success) {
                                            return {
                                                images: response.images || [],
                                                brands: response.brands || []
                                            };
                                        }
                                        throw new Error('API响应无效');
                                    } catch (apiError) {
                                        console.warn(`API请求失败 (尝试 ${retry + 1}/3):`, apiError);
                                        if (retry === 2) {
                                            throw apiError;
                                        }
                                        await new Promise(resolve => setTimeout(resolve, 1000));
                                    }
                                }
                            }
                        );
                        
                        if (cachedData) {
                            this.allImages = cachedData.images || [];
                            this.brandData = {};
                            
                            if (cachedData.brands && cachedData.brands.length > 0) {
                                cachedData.brands.forEach(brand => {
                                    this.brandData[brand.name] = brand;
                                });
                                this.filteredBrands = cachedData.brands;
                                this.generateFilterOptions();
                            } else if (this.allImages.length > 0) {
                                console.log('使用图片数据处理品牌信息');
                                this.processBrandData();
                            } else {
                                throw new Error('没有获取到有效的数据');
                            }
                            
                            this.dataLoaded = true;
                            console.log('数据加载完成');
                        } else {
                            throw new Error('数据加载失败');
                        }

                    } catch (error) {
                        console.error('加载数据失败:', error);
                        
                        // 设置友好的错误信息
                        if (error.message.includes('网络') || error.message.includes('连接')) {
                            this.error = '网络连接失败，请检查网络连接';
                        } else if (error.message.includes('API')) {
                            this.error = 'API服务暂时不可用，请稍后重试';
                        } else {
                            this.error = error.message || '加载数据失败，请刷新页面重试';
                        }
                        
                        // 确保有一些默认数据显示，避免完全空白
                        if (!this.filteredBrands || this.filteredBrands.length === 0) {
                            this.filteredBrands = [];
                            this.brandData = {};
                        }
                    } finally {
                        this.loading = false;
                    }
                },

                generateFilterOptions() {
                    // 从品牌数据中提取唯一的筛选选项并统计数量
                    const yearCounts = {};
                    const materialCounts = {};
                    const themeSeriesCounts = {};
                    const printSizeCounts = {};
                    
                    Object.values(this.brandData).forEach(brand => {
                        if (brand.year) {
                            const year = brand.year.toString();
                            yearCounts[year] = (yearCounts[year] || 0) + 1;
                        }
                        if (brand.material) {
                            materialCounts[brand.material] = (materialCounts[brand.material] || 0) + 1;
                        }
                        if (brand.theme_series) {
                            themeSeriesCounts[brand.theme_series] = (themeSeriesCounts[brand.theme_series] || 0) + 1;
                        }
                        if (brand.print_size) {
                            printSizeCounts[brand.print_size] = (printSizeCounts[brand.print_size] || 0) + 1;
                        }
                    });
                    
                    // 生成带统计数量的选项（不包含"全部"）
                    this.filterOptions = {
                        years: Object.keys(yearCounts).sort((a, b) => b.localeCompare(a)),
                        materials: Object.keys(materialCounts).sort(),
                        theme_series: Object.keys(themeSeriesCounts).sort(),
                        print_sizes: Object.keys(printSizeCounts).sort()
                    };
                    
                    // 保存统计数量
                    this.brandCounts = {
                        years: yearCounts,
                        materials: materialCounts,
                        theme_series: themeSeriesCounts,
                        print_sizes: printSizeCounts
                    };
                    
                    console.log('动态生成的筛选选项:', this.filterOptions);
                    console.log('统计数量:', this.brandCounts);
                },

                processBrandData() {
                    const brands = {};
                    
                    this.allImages.forEach(image => {
                        const brandName = image.brand_name;
                        

                        
                        if (!brands[brandName]) {
                            brands[brandName] = {
                                name: brandName,
                                images: [],
                                year: image.year || null,
                                material: image.material || null,
                                theme_series: image.theme_series || null,
                                print_size: image.print_size || null,
                                inspiration_origin: image.inspiration_origin || `${brandName}的设计灵感来源于传统文化与现代美学的融合。`
                            };
                        }
                        brands[brandName].images.push(image);
                    });

                    this.brandData = brands;
                    this.filteredBrands = Object.values(brands);
                    
                    // 生成筛选选项
                    this.generateFilterOptions();
                },

                filterBrands() {
                    let filtered = Object.values(this.brandData);

                    // 搜索过滤 - 支持多字段搜索
                    if (this.searchQuery.trim()) {
                        const query = this.searchQuery.toLowerCase();
                        filtered = filtered.filter(brand => 
                            brand.name.toLowerCase().includes(query) ||
                            (brand.material && brand.material.toLowerCase().includes(query)) ||
                            (brand.theme_series && brand.theme_series.toLowerCase().includes(query)) ||
                            (brand.print_size && brand.print_size.toLowerCase().includes(query)) ||
                            (brand.year && brand.year.toString().includes(query))
                        );
                    }

                    // 筛选过滤
                    Object.keys(this.activeFilters).forEach(key => {
                        const value = this.activeFilters[key];
                        if (value && value !== null && value !== undefined) {
                            // 映射前端字段名到数据字段名
                            const fieldMap = {
                                'materials': 'material',
                                'print_sizes': 'print_size'
                            };
                            const fieldName = fieldMap[key] || key;
                            
                            if (Array.isArray(value) && value.length > 0) {
                                // 多选模式：品牌必须匹配任一选中的值
                                filtered = filtered.filter(brand => 
                                    brand[fieldName] && value.includes(brand[fieldName])
                                );
                            } else if (!Array.isArray(value)) {
                                // 单选模式：品牌必须匹配选中的值
                                if (fieldName === 'year') {
                                    // 年份筛选特殊处理
                                    filtered = filtered.filter(brand => 
                                        brand[fieldName] && brand[fieldName].toString() === value.toString()
                                    );
                                } else {
                                    filtered = filtered.filter(brand => 
                                        brand[fieldName] && brand[fieldName] === value
                                    );
                                }
                            }
                        }
                    });

                    this.filteredBrands = filtered;
                    
                    // 更新筛选后的统计数量
                    this.updateFilterCounts(filtered);
                },
                
                // 更新筛选后的统计数量
                updateFilterCounts(filteredBrands) {
                    const yearCounts = {};
                    const materialCounts = {};
                    const themeSeriesCounts = {};
                    const printSizeCounts = {};
                    
                    // 重新计算当前筛选结果中的数量
                    filteredBrands.forEach(brand => {
                        if (brand.year) {
                            const year = brand.year.toString();
                            yearCounts[year] = (yearCounts[year] || 0) + 1;
                        }
                        if (brand.material) {
                            materialCounts[brand.material] = (materialCounts[brand.material] || 0) + 1;
                        }
                        if (brand.theme_series) {
                            themeSeriesCounts[brand.theme_series] = (themeSeriesCounts[brand.theme_series] || 0) + 1;
                        }
                        if (brand.print_size) {
                            printSizeCounts[brand.print_size] = (printSizeCounts[brand.print_size] || 0) + 1;
                        }
                    });
                    
                    // 更新当前筛选状态下的数量统计
                    this.currentFilterCounts = {
                        years: yearCounts,
                        materials: materialCounts,
                        theme_series: themeSeriesCounts,
                        print_sizes: printSizeCounts
                    };
                },

                toggleFilter(type, value) {
                    // 支持多选的筛选类型
                    const multiSelectTypes = ['materials', 'theme_series', 'print_sizes'];
                    
                    if (multiSelectTypes.includes(type)) {
                        // 多选模式：可以同时选择多个值
                        if (!this.activeFilters[type]) {
                            this.activeFilters[type] = [];
                        }
                        
                        const index = this.activeFilters[type].indexOf(value);
                        if (index > -1) {
                            this.activeFilters[type].splice(index, 1);
                            if (this.activeFilters[type].length === 0) {
                                this.activeFilters[type] = null;
                            }
                        } else {
                            this.activeFilters[type].push(value);
                        }
                    } else {
                        // 单选模式：年份只能选择一个
                        if (this.activeFilters[type] === value) {
                            this.activeFilters[type] = null;
                        } else {
                            this.activeFilters[type] = value;
                        }
                    }
                    
                    this.filterBrands();
                },

                clearAllFilters() {
                    this.activeFilters = {
                        year: null,
                        materials: null,
                        theme_series: null,
                        print_sizes: null
                    };
                    this.filterBrands();
                },

                getBrandCoverImage(brand) {
                    // 只显示设计图
                    const designImage = brand.images.find(img => img.image_type === '设计图');
                    if (designImage) {
                        // 使用前端静态文件路径，正确编码中文字符
                        const encodedPath = designImage.relative_path.split('/').map(part => encodeURIComponent(part)).join('/');
                        return `/static/images/${encodedPath}`;
                    }
                    // 如果没有设计图，尝试使用其他图片
                    if (brand.images.length > 0) {
                        const encodedPath = brand.images[0].relative_path.split('/').map(part => encodeURIComponent(part)).join('/');
                        return `/static/images/${encodedPath}`;
                    }
                    return null;
                },

                async openBrandDetail(brand) {
                    console.log('打开品牌详情:', brand);
                    
                    // 使用智能缓存管理器获取品牌详情
                    const brandDetail = await window.cacheManager.getOrFetch(
                        'brand_detail',
                        async () => {
                            console.log('从API获取品牌详情...');
                            try {
                                const response = await window.api.getBrandDetail(brand.name);
                                if (response && response.success && response.images) {
                                    return {
                                        brand_info: response.brand_info,
                                        images: response.images
                                    };
                                }
                            } catch (error) {
                                console.warn('API获取品牌详情失败:', error);
                            }
                            
                            // 如果API失败，使用本地数据
                            return {
                                brand_info: brand,
                                images: brand.images || []
                            };
                        },
                        brand.name
                    );
                    
                    // 设置品牌详情数据
                    this.selectedBrand = brandDetail.brand_info;
                    this.brandImages = brandDetail.images;
                    
                    // 显示模态框
                    this.showModal = true;
                    document.body.style.overflow = 'hidden';
                },

                closeModal() {
                    this.showModal = false;
                    document.body.style.overflow = 'auto';
                    setTimeout(() => {
                        this.selectedBrand = null;
                        this.brandImages = [];
                    }, 300);
                },

                getCategorizedImages() {
                    if (!this.selectedBrand || !this.selectedBrand.images) {
                        return {};
                    }
                    
                    const categories = {};
                    
                    this.selectedBrand.images.forEach(img => {
                        // 从文件名中提取图片类型
                        let type = '其他';
                        if (img.filename.includes('-设计图-') || img.filename.includes('设计图')) {
                            type = '设计图';
                        } else if (img.filename.includes('-布料图-') || img.filename.includes('布料图')) {
                            type = '布料图';
                        } else if (img.filename.includes('-成衣图-') || img.filename.includes('成衣图')) {
                            type = '成衣图';
                        } else if (img.filename.includes('-模特图-') || img.filename.includes('模特图')) {
                            type = '模特图';
                        } else if (img.filename.includes('-买家秀-') || img.filename.includes('买家秀')) {
                            type = '买家秀';
                        }
                        
                        if (!categories[type]) {
                            categories[type] = [];
                        }
                        categories[type].push(img);
                    });
                    
                    // 按预定义顺序排序
                    const orderedCategories = {};
                    const order = ['设计图', '布料图', '成衣图', '模特图', '买家秀', '其他'];
                    
                    order.forEach(type => {
                        if (categories[type] && categories[type].length > 0) {
                            orderedCategories[type] = categories[type];
                        }
                    });
                    
                    return orderedCategories;
                },

                groupImagesByColor(images) {
                    if (!images || images.length === 0) {
                        return {};
                    }
                    
                    const colorGroups = {};
                    
                    images.forEach(img => {
                        // 从文件名中提取颜色信息
                        let color = '默认色';
                        const filename = img.filename;
                        
                        // 匹配括号中的颜色信息
                        const colorMatch = filename.match(/\(([^)]+)\)/);
                        if (colorMatch) {
                            color = colorMatch[1];
                        }
                        
                        if (!colorGroups[color]) {
                            colorGroups[color] = [];
                        }
                        colorGroups[color].push(img);
                    });
                    
                    // 按文件名编号排序
                    Object.keys(colorGroups).forEach(color => {
                        colorGroups[color].sort((a, b) => {
                            const aNum = parseInt(a.filename.match(/-(\d+)\./)?.[1] || '0');
                            const bNum = parseInt(b.filename.match(/-(\d+)\./)?.[1] || '0');
                            return aNum - bNum;
                        });
                    });
                    
                    return colorGroups;
                },

                getDesignImages() {
                    return this.brandImages.filter(img => img.image_type === '设计图');
                },

                getFabricImages() {
                    return this.brandImages.filter(img => img.image_type === '布料图');
                },

                getImageURL(image) {
                    // 使用前端静态文件路径，正确编码中文字符
                    const encodedPath = image.relative_path.split('/').map(part => encodeURIComponent(part)).join('/');
                    return `/static/images/${encodedPath}`;
                },

                shareCard() {
                    try {
                        const brandName = this.selectedBrand.name || this.selectedBrand.brand_name || '未知品牌';
                        const shareData = {
                            title: `南意秋棠 - ${brandName}`,
                            text: `查看这个漂亮的汉文化布料设计：${brandName}`,
                            url: window.location.href
                        };

                        if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                            navigator.share(shareData).catch(err => {
                                console.log('分享失败:', err);
                                this.fallbackShare();
                            });
                        } else {
                            this.fallbackShare();
                        }
                    } catch (error) {
                        console.error('分享错误:', error);
                        this.fallbackShare();
                    }
                },

                fallbackShare() {
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(window.location.href).then(() => {
                            alert('链接已复制到剪贴板，您可以手动分享');
                        }).catch(() => {
                            this.showShareOptions();
                        });
                    } else {
                        this.showShareOptions();
                    }
                },

                showShareOptions() {
                    const brandName = this.selectedBrand.name || this.selectedBrand.brand_name || '未知品牌';
                    const message = `南意秋棠 - ${brandName}\n${window.location.href}`;
                    
                    // 尝试打开微信分享（仅在微信浏览器中有效）
                    if (/MicroMessenger/i.test(navigator.userAgent)) {
                        alert('请点击右上角分享按钮分享到微信');
                    } else {
                        // 创建一个临时文本区域来复制文本
                        const textArea = document.createElement('textarea');
                        textArea.value = message;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            alert('分享内容已复制，您可以粘贴到微信或其他平台分享');
                        } catch (err) {
                            alert(`请手动复制以下内容分享：\n${message}`);
                        }
                        document.body.removeChild(textArea);
                    }
                },

                handleImageError(event) {
                    // 图片加载失败时隐藏图片
                    event.target.style.display = 'none';
                },

                openImagePreview(image) {
                    this.previewImage = image;
                    document.body.style.overflow = 'hidden';
                },

                closeImagePreview() {
                    this.previewImage = null;
                    document.body.style.overflow = 'auto';
                },

                downloadImage(image) {
                    const link = document.createElement('a');
                    link.href = this.getImageURL(image);
                    link.download = image.filename || 'image.jpg';
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },

                openCustomerService() {
                    // 智能客服功能
                    const wechatId = 'LPumpkin0217';
                    const qqNumber = '502517787';

                    // 创建客服选择弹窗
                    const modal = document.createElement('div');
                    modal.className = 'customer-service-modal';
                    modal.innerHTML = `
                        <div class="customer-service-overlay" onclick="this.parentElement.remove()">
                            <div class="customer-service-content" onclick="event.stopPropagation()">
                                <div class="customer-service-header">
                                    <h3>联系客服</h3>
                                    <button onclick="this.closest('.customer-service-modal').remove()" class="close-btn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="customer-service-options">
                                    <div class="service-option" onclick="window.copyToClipboard('${wechatId}', '微信号')">
                                        <div class="service-icon">
                                            <i class="fab fa-weixin"></i>
                                        </div>
                                        <div class="service-info">
                                            <div class="service-name">微信客服</div>
                                            <div class="service-id">${wechatId}</div>
                                        </div>
                                        <div class="copy-hint">点击复制</div>
                                    </div>
                                    <div class="service-option" onclick="window.copyToClipboard('${qqNumber}', 'QQ号')">
                                        <div class="service-icon">
                                            <i class="fab fa-qq"></i>
                                        </div>
                                        <div class="service-info">
                                            <div class="service-name">QQ客服</div>
                                            <div class="service-id">${qqNumber}</div>
                                        </div>
                                        <div class="copy-hint">点击复制</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // 添加样式
                    const style = document.createElement('style');
                    style.textContent = `
                        .customer-service-modal {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            z-index: 10000;
                        }
                        .customer-service-overlay {
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.5);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }
                        .customer-service-content {
                            background: white;
                            border-radius: 12px;
                            padding: 0;
                            max-width: 400px;
                            width: 90%;
                            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                        }
                        .customer-service-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 1rem;
                            border-bottom: 1px solid #eee;
                        }
                        .customer-service-header h3 {
                            margin: 0;
                            color: #333;
                            font-size: 1.1rem;
                        }
                        .customer-service-options {
                            padding: 1rem;
                            display: flex;
                            flex-direction: column;
                            gap: 0.8rem;
                        }
                        .service-option {
                            display: flex;
                            align-items: center;
                            gap: 0.8rem;
                            padding: 0.8rem;
                            border: 2px solid #e5e7eb;
                            border-radius: 8px;
                            background: white;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            font-size: 0.9rem;
                        }
                        @media (max-width: 768px) {
                            .customer-service-content {
                                max-width: 320px;
                                width: 85%;
                            }
                            .customer-service-header {
                                padding: 0.8rem;
                            }
                            .customer-service-header h3 {
                                font-size: 1rem;
                            }
                            .customer-service-options {
                                padding: 0.8rem;
                                gap: 0.6rem;
                            }
                            .service-option {
                                gap: 0.6rem;
                                padding: 0.6rem;
                                font-size: 0.85rem;
                            }
                            .service-icon i {
                                font-size: 1.2rem !important;
                            }
                            .service-name {
                                font-size: 0.85rem;
                            }
                            .service-id {
                                font-size: 0.8rem;
                            }
                            .copy-hint {
                                font-size: 0.7rem;
                                padding: 0.2rem 0.4rem;
                            }
                        }
                        .service-option:hover {
                            border-color: #667eea;
                            background: #f8f9ff;
                            transform: translateY(-2px);
                        }
                        .service-icon i {
                            font-size: 1.5rem;
                            color: #667eea;
                        }
                        .service-info {
                            flex: 1;
                            text-align: left;
                        }
                        .service-name {
                            font-weight: 600;
                            color: #333;
                            margin-bottom: 0.25rem;
                        }
                        .service-id {
                            color: #667eea;
                            font-family: monospace;
                            font-size: 0.9rem;
                        }
                        .copy-hint {
                            color: #999;
                            font-size: 0.8rem;
                            background: #f3f4f6;
                            padding: 0.25rem 0.5rem;
                            border-radius: 4px;
                        }
                    `;

                    document.head.appendChild(style);
                    document.body.appendChild(modal);
                    
                    // 设置全局复制函数
                    window.copyToClipboard = this.copyToClipboard;
                },

                // 复制到剪贴板功能
                copyToClipboard(text, type) {
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(text).then(() => {
                            alert(`${type}已复制到剪贴板：${text}`);
                        }).catch(() => {
                            this.fallbackCopyTextToClipboard(text, type);
                        });
                    } else {
                        this.fallbackCopyTextToClipboard(text, type);
                    }
                },

                // 降级复制方案
                fallbackCopyTextToClipboard(text, type) {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        const successful = document.execCommand('copy');
                        if (successful) {
                            alert(`${type}已复制到剪贴板：${text}`);
                        } else {
                            alert(`复制失败，请手动复制：${text}`);
                        }
                    } catch (err) {
                        alert(`复制失败，请手动复制：${text}`);
                    }
                    
                    document.body.removeChild(textArea);
                },

                // 处理logo点击
                handleLogoClick(event) {
                    // 移动端直接跳转，不阻止默认行为
                    if (window.innerWidth <= 768) {
                        // 移动端：直接跳转
                        window.open('https://shop357296168.taobao.com/?spm=a21n57.shop_search.0.0.1ad93904ohsQt4', '_blank');
                        event.preventDefault(); // 阻止默认的a标签行为，使用我们的跳转
                    }
                    // 桌面端：使用默认的a标签行为
                },

                // 通过标签筛选品牌
                filterByTag(filterType, filterValue) {
                    console.log(`点击筛选: ${filterType} = ${filterValue}`);
                    
                    // 关闭模态框（如果是从详情页点击的）
                    if (this.showModal) {
                        this.closeModal();
                    }
                    
                    // 清除搜索框内容
                    this.searchQuery = '';
                    
                    // 支持标签的toggle功能
                    if (filterType === 'year') {
                        // 年份是单选，点击相同值则取消
                        if (this.activeFilters[filterType] === filterValue) {
                            this.activeFilters[filterType] = null;
                        } else {
                            this.activeFilters[filterType] = filterValue;
                        }
                    } else {
                        // 多选类型支持组合筛选
                        if (!this.activeFilters[filterType]) {
                            this.activeFilters[filterType] = [];
                        }
                        
                        const index = this.activeFilters[filterType].indexOf(filterValue);
                        if (index > -1) {
                            // 已存在，移除
                            this.activeFilters[filterType].splice(index, 1);
                            if (this.activeFilters[filterType].length === 0) {
                                this.activeFilters[filterType] = null;
                            }
                        } else {
                            // 不存在，添加
                            this.activeFilters[filterType].push(filterValue);
                        }
                    }
                    
                    // 应用筛选
                    this.filterBrands();
                    
                    // 滚动到筛选区域
                    const filterSection = document.querySelector('.filter-section');
                    if (filterSection) {
                        filterSection.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }
                },

                // 清除单个筛选条件
                clearFilter(filterType) {
                    console.log(`清除筛选: ${filterType}`);
                    
                    // 清除指定的筛选条件
                    this.activeFilters[filterType] = null;
                    
                    // 应用筛选
                    this.filterBrands();
                },

                // 检查是否有任何活跃的筛选条件
                hasAnyActiveFilters() {
                    return Object.values(this.activeFilters).some(filter => 
                        filter !== null && 
                        filter !== undefined && 
                        (Array.isArray(filter) ? filter.length > 0 : true)
                    );
                },

                // 简单的Markdown格式化
                formatMarkdown(text) {
                    if (!text) return '';
                    
                    return text
                        // 粗体 **text** 或 __text__
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/__(.*?)__/g, '<strong>$1</strong>')
                        // 斜体 *text* 或 _text_
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/_(.*?)_/g, '<em>$1</em>')
                        // 换行
                        .replace(/\n/g, '<br>')
                        // 段落分隔
                        .replace(/\n\n/g, '</p><p>')
                        // 包装在段落中
                        .replace(/^(.+)$/, '<p>$1</p>');
                }
            }
        });

        // 全局错误处理
        app.config.errorHandler = (err, instance, info) => {
            console.error('Vue全局错误:', err);
            console.error('错误信息:', info);
            console.error('组件实例:', instance);
        };

        // 挂载应用
        try {
            app.mount('#app');
            console.log('Vue应用挂载成功');
        } catch (error) {
            console.error('Vue应用挂载失败:', error);
            document.getElementById('app').innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <h3>应用加载失败</h3>
                    <p>请刷新页面重试</p>
                    <button onclick="location.reload()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        刷新页面
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html> 